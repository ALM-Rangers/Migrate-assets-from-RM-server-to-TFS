// --------------------------------------------------------------------------------------------------------------------
// <copyright file="When_Parsing_Release_Template_Workflow_Actions.cs" company="Microsoft Corporation">
//   Copyright Microsoft Corporation. All Rights Reserved. This code released under the terms of the MIT License (MIT, https://github.com/ALM-Rangers/Migrate-assets-from-RM-server-to-VSO/blob/master/License.txt). This is sample code only, do not use in production environments.
// </copyright>
// --------------------------------------------------------------------------------------------------------------------

 // ReSharper disable InconsistentNaming

namespace Microsoft.ALMRangers.RMWorkflowMigrator.Tests.Unit
{
    using System;
    using System.Diagnostics.CodeAnalysis;
    using System.Linq;

    using Microsoft.ALMRangers.RMWorkflowMigrator.DataAccess.Model;
    using Microsoft.ALMRangers.RMWorkflowMigrator.Parser;
    using Microsoft.ALMRangers.RMWorkflowMigrator.Parser.Model;
    using Microsoft.VisualStudio.TestTools.UnitTesting;

    [ExcludeFromCodeCoverage]
    [TestClass]
    public class When_Parsing_Release_Template_Workflow_Actions
    {
        [TestMethod]
        public void Can_Detect_A_Disabled_Action()
        {
            // Arrange
            var testXml =
                @"<DeploymentSequenceActivity xmlns=""clr-namespace:Microsoft.TeamFoundation.Release.Workflow.Activities;assembly=Microsoft.TeamFoundation.Release.Workflow"" xmlns:mtrdm=""clr-namespace:Microsoft.TeamFoundation.Release.Data.Model;assembly=Microsoft.TeamFoundation.Release.Data"" xmlns:mva=""clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"" xmlns:p=""http://schemas.microsoft.com/netfx/2009/xaml/activities"" xmlns:sap=""http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"" xmlns:scg=""clr-namespace:System.Collections.Generic;assembly=mscorlib"" xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml"" DisplayName=""Deployment Sequence"" sap:VirtualizedContainerService.HintSize=""398.4,982.4"" mva:VisualBasic.Settings=""Assembly references and imported namespaces serialized as XML namespaces""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><ServerActivity sap:VirtualizedContainerService.HintSize=""376,857.6"" InstanceSequenceNumber=""1"" ServerId=""19"" ServerName=""lab-dmann""><ActionActivity DisplayName=""Stop Web Site"" sap:VirtualizedContainerService.HintSize=""353.6,81.6"" IsSkipped=""False"" WorkflowActivityId=""8b6c8817-e7a0-404f-b265-a5bf36e96b88""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Stop Web Site"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3963"" HasPendingSecurityChanges=""False"" Id=""-69607"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""0"" LinkedV2ComponentId=""0"" ServerId=""19"" ServerInstanceSequenceNumber=""1"" ServerName=""lab-dmann"" StatusId=""2"" StatusName=""Active"" WorkflowActivityId=""8b6c8817-e7a0-404f-b265-a5bf36e96b88""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""2"" ActionTypeName=""Custom action"" ApplyFullValidation=""False"" CategoryId=""2005"" CategoryName=""IIS"" DeployerToolId=""0"" DeploymentMethod=""2013"" Description=""Stop a web site (IIS 7.0+)"" HasPendingSecurityChanges=""False"" Id=""3963"" InMemoryStatus=""New"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""True"" IsSerializing=""False"" Name=""Stop Web Site"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""4"" TypeName=""Without source"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID0"" Id=""9879"" Name=""SiteName"" Value=""placeholder"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID0</x:Reference></ActionActivity.StageActivityVariables><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></ActionActivity><RollbackActivity DisplayName=""Rollback"" sap:VirtualizedContainerService.HintSize=""353.6,206.4""><ActionActivity DisplayName=""Start Web Site"" sap:VirtualizedContainerService.HintSize=""318.4,81.6"" IsSkipped=""False"" WorkflowActivityId=""a57638ce-128f-4a03-91e4-0aa16f3fbae0""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Start Web Site"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3962"" HasPendingSecurityChanges=""False"" Id=""-302956"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""0"" LinkedV2ComponentId=""0"" ServerId=""19"" ServerInstanceSequenceNumber=""1"" ServerName=""lab-dmann"" StatusId=""2"" StatusName=""Active"" WorkflowActivityId=""a57638ce-128f-4a03-91e4-0aa16f3fbae0""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""2"" ActionTypeName=""Custom action"" ApplyFullValidation=""False"" CategoryId=""2005"" CategoryName=""IIS"" DeployerToolId=""0"" DeploymentMethod=""2013"" Description=""Start a web site (IIS 7.0+)"" HasPendingSecurityChanges=""False"" Id=""3962"" InMemoryStatus=""New"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""True"" IsSerializing=""False"" Name=""Start Web Site"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""4"" TypeName=""Without source"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID1"" Id=""9878"" Name=""SiteName"" Value=""bar"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID1</x:Reference></ActionActivity.StageActivityVariables><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></ActionActivity></RollbackActivity><ComponentActivity DisplayName=""Daniel Web Site Component"" sap:VirtualizedContainerService.HintSize=""353.6,118.4"" IsSkipped=""True"" WorkflowActivityId=""2abb2d8e-21e7-4829-a426-339d3d7971ae""><ComponentActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Daniel Web Site Component"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""4033"" HasPendingSecurityChanges=""False"" Id=""-910621"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""0"" LinkedV2ComponentId=""0"" ServerId=""19"" ServerInstanceSequenceNumber=""1"" ServerName=""lab-dmann"" StatusId=""2"" StatusName=""Active"" WorkflowActivityId=""2abb2d8e-21e7-4829-a426-339d3d7971ae""><mtrdm:StageActivity.Component><mtrdm:ApplicationVersionComponent Id=""4033"" InMemoryStatus=""Existing"" Name=""Daniel Web Site Component"" OverrideRelativePathToPackageLocation=""""><mtrdm:ApplicationVersionComponent.ConfigurationVariables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID2"" Id=""10075"" Name=""Installation Path"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID3"" Id=""10087"" Name=""ConfigVariable1"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID4"" Id=""10088"" Name=""EncryptedConfigVariable"" Value="""" /></mtrdm:ApplicationVersionComponent.ConfigurationVariables><mtrdm:ApplicationVersionComponent.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:ApplicationVersionComponent.PropertyBagVariables></mtrdm:ApplicationVersionComponent></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID5"" Id=""10075"" Name=""Installation Path"" Value=""a"" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID6"" Id=""10087"" Name=""ConfigVariable1"" Value=""b"" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID7"" Id=""10088"" Name=""EncryptedConfigVariable"" Value=""c"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ComponentActivity.StageActivity><ComponentActivity.StageActivityVariables><x:Reference>__ReferenceID5</x:Reference><x:Reference>__ReferenceID6</x:Reference><x:Reference>__ReferenceID7</x:Reference></ComponentActivity.StageActivityVariables><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></ComponentActivity><RollbackAlwaysActivity DisplayName=""Rollback Always"" sap:VirtualizedContainerService.HintSize=""353.6,206.4""><ActionActivity DisplayName=""Start Application Pool"" sap:VirtualizedContainerService.HintSize=""318.4,81.6"" IsSkipped=""False"" WorkflowActivityId=""5c61c0d4-f1df-466c-8456-3c07ae6fa4e2""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Start Application Pool"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3966"" HasPendingSecurityChanges=""False"" Id=""-677535"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""0"" LinkedV2ComponentId=""0"" ServerId=""19"" ServerInstanceSequenceNumber=""1"" ServerName=""lab-dmann"" StatusId=""2"" StatusName=""Active"" WorkflowActivityId=""5c61c0d4-f1df-466c-8456-3c07ae6fa4e2""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""2"" ActionTypeName=""Custom action"" ApplyFullValidation=""False"" CategoryId=""2005"" CategoryName=""IIS"" DeployerToolId=""0"" DeploymentMethod=""2013"" Description=""Start an application pool (IIS 7.0+)"" HasPendingSecurityChanges=""False"" Id=""3966"" InMemoryStatus=""New"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""True"" IsSerializing=""False"" Name=""Start Application Pool"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""4"" TypeName=""Without source"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID8"" Id=""9890"" Name=""AppPoolName"" Value=""baz"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID8</x:Reference></ActionActivity.StageActivityVariables><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></ActionActivity></RollbackAlwaysActivity></ServerActivity></DeploymentSequenceActivity>";

            // Act
            var sequence = (new RMDeploymentSequence { StageId = 100, WorkflowXaml = testXml }).ToReleaseTemplate();

            // Assert
            var servers = sequence.Containers.ToList();
            var actions = servers[0].SubItems.Cast<ReleaseAction>().ToList();
            Assert.IsFalse(actions[2].Enabled);
        }

        [TestMethod]
        public void Can_Parse_A_Manual_Intervention_With_A_Group_Notified()
        {
            // Arrange
            var testXml =
                @"<DeploymentSequenceActivity xmlns=""clr-namespace:Microsoft.TeamFoundation.Release.Workflow.Activities;assembly=Microsoft.TeamFoundation.Release.Workflow"" xmlns:mtrdm=""clr-namespace:Microsoft.TeamFoundation.Release.Data.Model;assembly=Microsoft.TeamFoundation.Release.Data"" xmlns:mva=""clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"" xmlns:p=""http://schemas.microsoft.com/netfx/2009/xaml/activities"" xmlns:sap=""http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"" xmlns:scg=""clr-namespace:System.Collections.Generic;assembly=mscorlib"" xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml"" DisplayName=""Deployment Sequence"" sap:VirtualizedContainerService.HintSize=""385.6,1801.6"" IsStageEditable=""True"" mva:VisualBasic.Settings=""Assembly references and imported namespaces serialized as XML namespaces""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><ServerTagActivity ExecutionMode=""1"" sap:VirtualizedContainerService.HintSize=""363.2,1676.8"" InstanceSequenceNumber=""1"" TagName=""placeholder""><ActionActivity DisplayName=""Copy File or Folder"" sap:VirtualizedContainerService.HintSize=""340.8,99.2"" IsSkipped=""False"" WorkflowActivityId=""059a330d-6414-4ebd-88c7-125abd1121c3""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Copy File or Folder"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3981"" HasPendingSecurityChanges=""False"" Id=""-889042"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""1"" LinkedV2ComponentId=""0"" Name=""placeholder"" ServerId=""0"" ServerInstanceSequenceNumber=""1"" StatusId=""2"" StatusName=""Active"" TagName=""placeholder"" WorkflowActivityId=""059a330d-6414-4ebd-88c7-125abd1121c3""><mtrdm:StageActivity.Component><mtrdm:Component x:Name=""__ReferenceID4"" ActionTypeId=""1"" ApplyFullValidation=""False"" Arguments=""&quot;__SourceFileFolder__&quot; &quot;__DestinationFileFolder__&quot;"" CategoryId=""1998"" CategoryName=""Windows OS"" Command=""irxcopy.cmd"" DeployerToolId=""12"" DeploymentMethod=""2013"" Description=""Copy file(s) or folder (wildcards can be used)"" HasPendingSecurityChanges=""False"" Id=""3981"" InMemoryStatus=""Existing"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""False"" IsSerializing=""False"" Name=""Copy File or Folder"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""3"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:ConfigurationVariable Id=""-783802"" Name=""SourceFileFolder"" Value="""" /><mtrdm:ConfigurationVariable Id=""-783802"" Name=""DestinationFileFolder"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID0"" Id=""9950"" Name=""SourceFileFolder"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID1"" Id=""9951"" Name=""DestinationFileFolder"" Value="""" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID2"" Id=""9950"" Name=""SourceFileFolder"" Value=""C:\placeholder"" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID3"" Id=""9951"" Name=""DestinationFileFolder"" Value=""C:\bar"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID2</x:Reference><x:Reference>__ReferenceID3</x:Reference></ActionActivity.StageActivityVariables><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></ActionActivity><ManualInterventionActivity Details=""This is also text. I love text."" DisplayName=""An additional manual intervention"" sap:VirtualizedContainerService.HintSize=""340.8,236.8"" Recipient=""2:5"" WorkflowActivityId=""57bbb5a5-c6d4-4872-9b56-43a032e271a3"" /><RollbackActivity DisplayName=""Rollback"" sap:VirtualizedContainerService.HintSize=""340.8,60.8""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">False</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><ActionActivity DisplayName=""Copy File or Folder"" sap:VirtualizedContainerService.HintSize=""334.4,99.2"" IsSkipped=""False"" WorkflowActivityId=""d569c822-b8ac-493c-b8d7-954eab1e93f2""><ActionActivity.StageActivity><mtrdm:StageActivity Component=""{x:Reference __ReferenceID4}"" ActivityDisplayName=""Copy File or Folder"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3981"" HasPendingSecurityChanges=""False"" Id=""-169769"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""1"" LinkedV2ComponentId=""0"" Name=""placeholder"" ServerId=""0"" ServerInstanceSequenceNumber=""1"" StatusId=""2"" StatusName=""Active"" TagName=""placeholder"" WorkflowActivityId=""d569c822-b8ac-493c-b8d7-954eab1e93f2""><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID5"" Id=""9950"" Name=""SourceFileFolder"" Value=""C:\bar"" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID6"" Id=""9951"" Name=""DestinationFileFolder"" Value=""C:\placeholder"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID5</x:Reference><x:Reference>__ReferenceID6</x:Reference></ActionActivity.StageActivityVariables><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></ActionActivity></RollbackActivity><ActionActivity DisplayName=""Create Folder"" sap:VirtualizedContainerService.HintSize=""340.8,81.6"" IsSkipped=""False"" WorkflowActivityId=""104db2c3-8139-4946-ae75-8f5cd46b90f1""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Create Folder"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3982"" HasPendingSecurityChanges=""False"" Id=""-477175"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""1"" LinkedV2ComponentId=""0"" Name=""placeholder"" ServerId=""0"" ServerInstanceSequenceNumber=""1"" StatusId=""2"" StatusName=""Active"" TagName=""placeholder"" WorkflowActivityId=""104db2c3-8139-4946-ae75-8f5cd46b90f1""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""1"" ApplyFullValidation=""False"" Arguments=""-command ./ManageWindowsIO.ps1 -Action Create -FileFolderName '__FolderName__'"" CategoryId=""1998"" CategoryName=""Windows OS"" Command=""powershell"" DeployerToolId=""2011"" DeploymentMethod=""2013"" Description=""Create a folder"" HasPendingSecurityChanges=""False"" Id=""3982"" InMemoryStatus=""Existing"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""False"" IsSerializing=""False"" Name=""Create Folder"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""3"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:ConfigurationVariable Id=""-588617"" Name=""FolderName"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID7"" Id=""9952"" Name=""FolderName"" Value="""" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID8"" Id=""9952"" Name=""FolderName"" Value=""C:\baz"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID8</x:Reference></ActionActivity.StageActivityVariables><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></ActionActivity><RollbackActivity DisplayName=""Rollback"" sap:VirtualizedContainerService.HintSize=""340.8,297.6""><ActionActivity DisplayName=""Create Web Site"" sap:VirtualizedContainerService.HintSize=""318.4,172.8"" IsSkipped=""False"" WorkflowActivityId=""e64d23d1-5f4d-4c6c-b43c-485d1ed5c664""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Create Web Site"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""4009"" HasPendingSecurityChanges=""False"" Id=""-738900"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""1"" LinkedV2ComponentId=""0"" Name=""placeholder"" ServerId=""0"" ServerInstanceSequenceNumber=""1"" StatusId=""2"" StatusName=""Active"" TagName=""placeholder"" WorkflowActivityId=""e64d23d1-5f4d-4c6c-b43c-485d1ed5c664""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""1"" ApplyFullValidation=""False"" Arguments=""-CreateWebSite -sn &quot;__SiteName__&quot; -port __PortNumber__ -pd &quot;__PhysicalPath__&quot; -ap &quot;__AppPoolName__&quot; -enablepreload __IsPreloadEnabled__ -autostart __IsAutoStart__"" CategoryId=""2005"" CategoryName=""IIS"" Command=""IISConfig.exe"" DeployerToolId=""2014"" DeploymentMethod=""2013"" Description=""Create a web site (IIS 6.0+)"" HasPendingSecurityChanges=""False"" Id=""4009"" InMemoryStatus=""Existing"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""False"" IsSerializing=""False"" Name=""Create Web Site"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""3"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:ConfigurationVariable Id=""-588617"" Name=""SiteName"" Value="""" /><mtrdm:ConfigurationVariable Id=""-588617"" Name=""PortNumber"" Value="""" /><mtrdm:ConfigurationVariable Id=""-229813"" Name=""PhysicalPath"" Value="""" /><mtrdm:ConfigurationVariable Id=""-229813"" Name=""AppPoolName"" Value="""" /><mtrdm:ConfigurationVariable Id=""-229813"" Name=""IsPreloadEnabled"" Value="""" /><mtrdm:ConfigurationVariable Id=""-229813"" Name=""IsAutoStart"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID9"" Id=""9881"" Name=""AppPoolName"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID10"" Id=""9882"" Name=""IsPreloadEnabled"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID11"" Id=""9883"" Name=""IsAutoStart"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID12"" Id=""10019"" Name=""SiteName"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID13"" Id=""10020"" Name=""PortNumber"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID14"" Id=""10021"" Name=""PhysicalPath"" Value="""" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID15"" Id=""9881"" Name=""AppPoolName"" Value=""a"" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID16"" Id=""9882"" Name=""IsPreloadEnabled"" Value=""b"" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID17"" Id=""9883"" Name=""IsAutoStart"" Value=""c"" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID18"" Id=""10019"" Name=""SiteName"" Value=""d"" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID19"" Id=""10020"" Name=""PortNumber"" Value=""e"" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID20"" Id=""10021"" Name=""PhysicalPath"" Value=""f"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID15</x:Reference><x:Reference>__ReferenceID16</x:Reference><x:Reference>__ReferenceID17</x:Reference><x:Reference>__ReferenceID18</x:Reference><x:Reference>__ReferenceID19</x:Reference><x:Reference>__ReferenceID20</x:Reference></ActionActivity.StageActivityVariables><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></ActionActivity></RollbackActivity><ActionActivity DisplayName=""Stop Service"" sap:VirtualizedContainerService.HintSize=""340.8,52.8"" IsSkipped=""False"" WorkflowActivityId=""2861aaa9-b1a9-4622-9e00-fe682964bae3""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Stop Service"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3991"" HasPendingSecurityChanges=""False"" Id=""-966172"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""1"" LinkedV2ComponentId=""0"" Name=""placeholder"" ServerId=""0"" ServerInstanceSequenceNumber=""1"" StatusId=""2"" StatusName=""Active"" TagName=""placeholder"" WorkflowActivityId=""2861aaa9-b1a9-4622-9e00-fe682964bae3""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""1"" ApplyFullValidation=""False"" Arguments=""-command ./ManageWindowsServices.ps1 -Action Stop -ServiceName '__ServiceName__'"" CategoryId=""1999"" CategoryName=""Windows Services"" Command=""powershell"" DeployerToolId=""2012"" DeploymentMethod=""2013"" Description=""Stop a Windows Service"" HasPendingSecurityChanges=""False"" Id=""3991"" InMemoryStatus=""Existing"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""False"" IsSerializing=""False"" Name=""Stop Service"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""3"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:ConfigurationVariable Id=""-393433"" Name=""ServiceName"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID21"" Id=""9971"" Name=""ServiceName"" Value="""" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID22"" Id=""9971"" Name=""ServiceName"" Value=""asdf"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID22</x:Reference></ActionActivity.StageActivityVariables></ActionActivity><RollbackAlwaysActivity DisplayName=""Rollback Always"" sap:VirtualizedContainerService.HintSize=""340.8,206.4""><ActionActivity DisplayName=""Start Service"" sap:VirtualizedContainerService.HintSize=""318.4,81.6"" IsSkipped=""False"" WorkflowActivityId=""56138e2a-91ad-4a79-bea1-6b092e533505""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Start Service"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3989"" HasPendingSecurityChanges=""False"" Id=""-892868"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""1"" LinkedV2ComponentId=""0"" Name=""placeholder"" ServerId=""0"" ServerInstanceSequenceNumber=""1"" StatusId=""2"" StatusName=""Active"" TagName=""placeholder"" WorkflowActivityId=""56138e2a-91ad-4a79-bea1-6b092e533505""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""1"" ApplyFullValidation=""False"" Arguments=""-command ./ManageWindowsServices.ps1 -Action Start -ServiceName '__ServiceName__'"" CategoryId=""1999"" CategoryName=""Windows Services"" Command=""powershell"" DeployerToolId=""2012"" DeploymentMethod=""2013"" Description=""Start a Windows Service"" HasPendingSecurityChanges=""False"" Id=""3989"" InMemoryStatus=""Existing"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""False"" IsSerializing=""False"" Name=""Start Service"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""3"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:ConfigurationVariable Id=""-393433"" Name=""ServiceName"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID23"" Id=""9969"" Name=""ServiceName"" Value="""" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID24"" Id=""9969"" Name=""ServiceName"" Value=""asdf"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID24</x:Reference></ActionActivity.StageActivityVariables><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></ActionActivity></RollbackAlwaysActivity></ServerTagActivity></DeploymentSequenceActivity>";

            // Act
            var sequence = (new RMDeploymentSequence { StageId = 100, WorkflowXaml = testXml }).ToReleaseTemplate();

            var containers = sequence.Containers.ToList();
            var actions = containers[0].SubItems.ToList();
            var manualIntervention =
                actions.Where(a => a.ItemType == BlockType.ManualIntervention).Cast<ManualIntervention>().First();

            // Assert   
            Assert.IsNotNull(manualIntervention);
            Assert.AreEqual("An additional manual intervention", manualIntervention.DisplayName);
            Assert.AreEqual(2, manualIntervention.Sequence);
            Assert.AreEqual("This is also text. I love text.", manualIntervention.Text);
            Assert.AreEqual(5, manualIntervention.UserId);
            Assert.AreEqual(true, manualIntervention.IsGroup);
        }

        [TestMethod]
        public void Can_Parse_A_Manual_Intervention_With_A_User_Notified()
        {
            // Arrange
            var testXml =
                @"<DeploymentSequenceActivity xmlns=""clr-namespace:Microsoft.TeamFoundation.Release.Workflow.Activities;assembly=Microsoft.TeamFoundation.Release.Workflow"" xmlns:mtrdm=""clr-namespace:Microsoft.TeamFoundation.Release.Data.Model;assembly=Microsoft.TeamFoundation.Release.Data"" xmlns:mva=""clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"" xmlns:p=""http://schemas.microsoft.com/netfx/2009/xaml/activities"" xmlns:sap=""http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"" xmlns:scg=""clr-namespace:System.Collections.Generic;assembly=mscorlib"" xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml"" DisplayName=""Deployment Sequence"" sap:VirtualizedContainerService.HintSize=""385.6,1801.6"" IsStageEditable=""True"" mva:VisualBasic.Settings=""Assembly references and imported namespaces serialized as XML namespaces""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><ServerTagActivity ExecutionMode=""1"" sap:VirtualizedContainerService.HintSize=""363.2,1676.8"" InstanceSequenceNumber=""1"" TagName=""placeholder""><ActionActivity DisplayName=""Copy File or Folder"" sap:VirtualizedContainerService.HintSize=""340.8,99.2"" IsSkipped=""False"" WorkflowActivityId=""059a330d-6414-4ebd-88c7-125abd1121c3""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Copy File or Folder"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3981"" HasPendingSecurityChanges=""False"" Id=""-889042"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""1"" LinkedV2ComponentId=""0"" Name=""placeholder"" ServerId=""0"" ServerInstanceSequenceNumber=""1"" StatusId=""2"" StatusName=""Active"" TagName=""placeholder"" WorkflowActivityId=""059a330d-6414-4ebd-88c7-125abd1121c3""><mtrdm:StageActivity.Component><mtrdm:Component x:Name=""__ReferenceID4"" ActionTypeId=""1"" ApplyFullValidation=""False"" Arguments=""&quot;__SourceFileFolder__&quot; &quot;__DestinationFileFolder__&quot;"" CategoryId=""1998"" CategoryName=""Windows OS"" Command=""irxcopy.cmd"" DeployerToolId=""12"" DeploymentMethod=""2013"" Description=""Copy file(s) or folder (wildcards can be used)"" HasPendingSecurityChanges=""False"" Id=""3981"" InMemoryStatus=""Existing"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""False"" IsSerializing=""False"" Name=""Copy File or Folder"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""3"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:ConfigurationVariable Id=""-783802"" Name=""SourceFileFolder"" Value="""" /><mtrdm:ConfigurationVariable Id=""-783802"" Name=""DestinationFileFolder"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID0"" Id=""9950"" Name=""SourceFileFolder"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID1"" Id=""9951"" Name=""DestinationFileFolder"" Value="""" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID2"" Id=""9950"" Name=""SourceFileFolder"" Value=""C:\placeholder"" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID3"" Id=""9951"" Name=""DestinationFileFolder"" Value=""C:\bar"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID2</x:Reference><x:Reference>__ReferenceID3</x:Reference></ActionActivity.StageActivityVariables><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></ActionActivity><ManualInterventionActivity Details=""Text text text&#xA;&#xA;More text&#xA;&#xA;Lots more text!!"" DisplayName=""My Wonderful Manual Intervention"" sap:VirtualizedContainerService.HintSize=""340.8,236.8"" Recipient=""1:9052"" WorkflowActivityId=""c5b00a78-aedf-4def-8c3b-e7030f972a59"" /><RollbackActivity DisplayName=""Rollback"" sap:VirtualizedContainerService.HintSize=""340.8,60.8""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">False</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><ActionActivity DisplayName=""Copy File or Folder"" sap:VirtualizedContainerService.HintSize=""334.4,99.2"" IsSkipped=""False"" WorkflowActivityId=""d569c822-b8ac-493c-b8d7-954eab1e93f2""><ActionActivity.StageActivity><mtrdm:StageActivity Component=""{x:Reference __ReferenceID4}"" ActivityDisplayName=""Copy File or Folder"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3981"" HasPendingSecurityChanges=""False"" Id=""-169769"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""1"" LinkedV2ComponentId=""0"" Name=""placeholder"" ServerId=""0"" ServerInstanceSequenceNumber=""1"" StatusId=""2"" StatusName=""Active"" TagName=""placeholder"" WorkflowActivityId=""d569c822-b8ac-493c-b8d7-954eab1e93f2""><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID5"" Id=""9950"" Name=""SourceFileFolder"" Value=""C:\bar"" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID6"" Id=""9951"" Name=""DestinationFileFolder"" Value=""C:\placeholder"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID5</x:Reference><x:Reference>__ReferenceID6</x:Reference></ActionActivity.StageActivityVariables><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></ActionActivity></RollbackActivity><ActionActivity DisplayName=""Create Folder"" sap:VirtualizedContainerService.HintSize=""340.8,81.6"" IsSkipped=""False"" WorkflowActivityId=""104db2c3-8139-4946-ae75-8f5cd46b90f1""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Create Folder"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3982"" HasPendingSecurityChanges=""False"" Id=""-477175"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""1"" LinkedV2ComponentId=""0"" Name=""placeholder"" ServerId=""0"" ServerInstanceSequenceNumber=""1"" StatusId=""2"" StatusName=""Active"" TagName=""placeholder"" WorkflowActivityId=""104db2c3-8139-4946-ae75-8f5cd46b90f1""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""1"" ApplyFullValidation=""False"" Arguments=""-command ./ManageWindowsIO.ps1 -Action Create -FileFolderName '__FolderName__'"" CategoryId=""1998"" CategoryName=""Windows OS"" Command=""powershell"" DeployerToolId=""2011"" DeploymentMethod=""2013"" Description=""Create a folder"" HasPendingSecurityChanges=""False"" Id=""3982"" InMemoryStatus=""Existing"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""False"" IsSerializing=""False"" Name=""Create Folder"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""3"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:ConfigurationVariable Id=""-588617"" Name=""FolderName"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID7"" Id=""9952"" Name=""FolderName"" Value="""" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID8"" Id=""9952"" Name=""FolderName"" Value=""C:\baz"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID8</x:Reference></ActionActivity.StageActivityVariables><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></ActionActivity><RollbackActivity DisplayName=""Rollback"" sap:VirtualizedContainerService.HintSize=""340.8,297.6""><ActionActivity DisplayName=""Create Web Site"" sap:VirtualizedContainerService.HintSize=""318.4,172.8"" IsSkipped=""False"" WorkflowActivityId=""e64d23d1-5f4d-4c6c-b43c-485d1ed5c664""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Create Web Site"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""4009"" HasPendingSecurityChanges=""False"" Id=""-738900"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""1"" LinkedV2ComponentId=""0"" Name=""placeholder"" ServerId=""0"" ServerInstanceSequenceNumber=""1"" StatusId=""2"" StatusName=""Active"" TagName=""placeholder"" WorkflowActivityId=""e64d23d1-5f4d-4c6c-b43c-485d1ed5c664""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""1"" ApplyFullValidation=""False"" Arguments=""-CreateWebSite -sn &quot;__SiteName__&quot; -port __PortNumber__ -pd &quot;__PhysicalPath__&quot; -ap &quot;__AppPoolName__&quot; -enablepreload __IsPreloadEnabled__ -autostart __IsAutoStart__"" CategoryId=""2005"" CategoryName=""IIS"" Command=""IISConfig.exe"" DeployerToolId=""2014"" DeploymentMethod=""2013"" Description=""Create a web site (IIS 6.0+)"" HasPendingSecurityChanges=""False"" Id=""4009"" InMemoryStatus=""Existing"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""False"" IsSerializing=""False"" Name=""Create Web Site"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""3"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:ConfigurationVariable Id=""-588617"" Name=""SiteName"" Value="""" /><mtrdm:ConfigurationVariable Id=""-588617"" Name=""PortNumber"" Value="""" /><mtrdm:ConfigurationVariable Id=""-229813"" Name=""PhysicalPath"" Value="""" /><mtrdm:ConfigurationVariable Id=""-229813"" Name=""AppPoolName"" Value="""" /><mtrdm:ConfigurationVariable Id=""-229813"" Name=""IsPreloadEnabled"" Value="""" /><mtrdm:ConfigurationVariable Id=""-229813"" Name=""IsAutoStart"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID9"" Id=""9881"" Name=""AppPoolName"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID10"" Id=""9882"" Name=""IsPreloadEnabled"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID11"" Id=""9883"" Name=""IsAutoStart"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID12"" Id=""10019"" Name=""SiteName"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID13"" Id=""10020"" Name=""PortNumber"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID14"" Id=""10021"" Name=""PhysicalPath"" Value="""" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID15"" Id=""9881"" Name=""AppPoolName"" Value=""a"" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID16"" Id=""9882"" Name=""IsPreloadEnabled"" Value=""b"" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID17"" Id=""9883"" Name=""IsAutoStart"" Value=""c"" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID18"" Id=""10019"" Name=""SiteName"" Value=""d"" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID19"" Id=""10020"" Name=""PortNumber"" Value=""e"" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID20"" Id=""10021"" Name=""PhysicalPath"" Value=""f"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID15</x:Reference><x:Reference>__ReferenceID16</x:Reference><x:Reference>__ReferenceID17</x:Reference><x:Reference>__ReferenceID18</x:Reference><x:Reference>__ReferenceID19</x:Reference><x:Reference>__ReferenceID20</x:Reference></ActionActivity.StageActivityVariables><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></ActionActivity></RollbackActivity><ActionActivity DisplayName=""Stop Service"" sap:VirtualizedContainerService.HintSize=""340.8,52.8"" IsSkipped=""False"" WorkflowActivityId=""2861aaa9-b1a9-4622-9e00-fe682964bae3""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Stop Service"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3991"" HasPendingSecurityChanges=""False"" Id=""-966172"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""1"" LinkedV2ComponentId=""0"" Name=""placeholder"" ServerId=""0"" ServerInstanceSequenceNumber=""1"" StatusId=""2"" StatusName=""Active"" TagName=""placeholder"" WorkflowActivityId=""2861aaa9-b1a9-4622-9e00-fe682964bae3""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""1"" ApplyFullValidation=""False"" Arguments=""-command ./ManageWindowsServices.ps1 -Action Stop -ServiceName '__ServiceName__'"" CategoryId=""1999"" CategoryName=""Windows Services"" Command=""powershell"" DeployerToolId=""2012"" DeploymentMethod=""2013"" Description=""Stop a Windows Service"" HasPendingSecurityChanges=""False"" Id=""3991"" InMemoryStatus=""Existing"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""False"" IsSerializing=""False"" Name=""Stop Service"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""3"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:ConfigurationVariable Id=""-393433"" Name=""ServiceName"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID21"" Id=""9971"" Name=""ServiceName"" Value="""" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID22"" Id=""9971"" Name=""ServiceName"" Value=""asdf"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID22</x:Reference></ActionActivity.StageActivityVariables></ActionActivity><RollbackAlwaysActivity DisplayName=""Rollback Always"" sap:VirtualizedContainerService.HintSize=""340.8,206.4""><ActionActivity DisplayName=""Start Service"" sap:VirtualizedContainerService.HintSize=""318.4,81.6"" IsSkipped=""False"" WorkflowActivityId=""56138e2a-91ad-4a79-bea1-6b092e533505""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Start Service"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3989"" HasPendingSecurityChanges=""False"" Id=""-892868"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""1"" LinkedV2ComponentId=""0"" Name=""placeholder"" ServerId=""0"" ServerInstanceSequenceNumber=""1"" StatusId=""2"" StatusName=""Active"" TagName=""placeholder"" WorkflowActivityId=""56138e2a-91ad-4a79-bea1-6b092e533505""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""1"" ApplyFullValidation=""False"" Arguments=""-command ./ManageWindowsServices.ps1 -Action Start -ServiceName '__ServiceName__'"" CategoryId=""1999"" CategoryName=""Windows Services"" Command=""powershell"" DeployerToolId=""2012"" DeploymentMethod=""2013"" Description=""Start a Windows Service"" HasPendingSecurityChanges=""False"" Id=""3989"" InMemoryStatus=""Existing"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""False"" IsSerializing=""False"" Name=""Start Service"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""3"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:ConfigurationVariable Id=""-393433"" Name=""ServiceName"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID23"" Id=""9969"" Name=""ServiceName"" Value="""" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID24"" Id=""9969"" Name=""ServiceName"" Value=""asdf"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID24</x:Reference></ActionActivity.StageActivityVariables><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></ActionActivity></RollbackAlwaysActivity></ServerTagActivity></DeploymentSequenceActivity>";

            // Act
            var sequence = (new RMDeploymentSequence { StageId = 100, WorkflowXaml = testXml }).ToReleaseTemplate();

            var containers = sequence.Containers.ToList();
            var actions = containers[0].SubItems.ToList();
            var manualIntervention =
                actions.Where(a => a.ItemType == BlockType.ManualIntervention).Cast<ManualIntervention>().First();

            // Assert   
            Assert.IsNotNull(manualIntervention);
            Assert.AreEqual("My Wonderful Manual Intervention", manualIntervention.DisplayName);
            Assert.AreEqual(2, manualIntervention.Sequence);
            Assert.AreEqual("Text text text\n\nMore text\n\nLots more text!!", manualIntervention.Text);
            Assert.AreEqual(9052, manualIntervention.UserId);
            Assert.AreEqual(false, manualIntervention.IsGroup);
        }

        [TestMethod]
        public void Can_Parse_A_Rollback_Always_Block()
        {
            // Arrange
            var testXml =
                @"<DeploymentSequenceActivity xmlns=""clr-namespace:Microsoft.TeamFoundation.Release.Workflow.Activities;assembly=Microsoft.TeamFoundation.Release.Workflow"" xmlns:mtrdm=""clr-namespace:Microsoft.TeamFoundation.Release.Data.Model;assembly=Microsoft.TeamFoundation.Release.Data"" xmlns:mva=""clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"" xmlns:p=""http://schemas.microsoft.com/netfx/2009/xaml/activities"" xmlns:sap=""http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"" xmlns:scg=""clr-namespace:System.Collections.Generic;assembly=mscorlib"" xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml"" DisplayName=""Deployment Sequence"" sap:VirtualizedContainerService.HintSize=""398.4,982.4"" mva:VisualBasic.Settings=""Assembly references and imported namespaces serialized as XML namespaces""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><ServerActivity sap:VirtualizedContainerService.HintSize=""376,857.6"" InstanceSequenceNumber=""1"" ServerId=""19"" ServerName=""lab-dmann""><ActionActivity DisplayName=""Stop Web Site"" sap:VirtualizedContainerService.HintSize=""353.6,81.6"" IsSkipped=""False"" WorkflowActivityId=""8b6c8817-e7a0-404f-b265-a5bf36e96b88""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Stop Web Site"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3963"" HasPendingSecurityChanges=""False"" Id=""-69607"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""0"" LinkedV2ComponentId=""0"" ServerId=""19"" ServerInstanceSequenceNumber=""1"" ServerName=""lab-dmann"" StatusId=""2"" StatusName=""Active"" WorkflowActivityId=""8b6c8817-e7a0-404f-b265-a5bf36e96b88""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""2"" ActionTypeName=""Custom action"" ApplyFullValidation=""False"" CategoryId=""2005"" CategoryName=""IIS"" DeployerToolId=""0"" DeploymentMethod=""2013"" Description=""Stop a web site (IIS 7.0+)"" HasPendingSecurityChanges=""False"" Id=""3963"" InMemoryStatus=""New"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""True"" IsSerializing=""False"" Name=""Stop Web Site"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""4"" TypeName=""Without source"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID0"" Id=""9879"" Name=""SiteName"" Value=""placeholder"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID0</x:Reference></ActionActivity.StageActivityVariables><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></ActionActivity><RollbackActivity DisplayName=""Rollback"" sap:VirtualizedContainerService.HintSize=""353.6,206.4""><ActionActivity DisplayName=""Start Web Site"" sap:VirtualizedContainerService.HintSize=""318.4,81.6"" IsSkipped=""False"" WorkflowActivityId=""a57638ce-128f-4a03-91e4-0aa16f3fbae0""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Start Web Site"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3962"" HasPendingSecurityChanges=""False"" Id=""-302956"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""0"" LinkedV2ComponentId=""0"" ServerId=""19"" ServerInstanceSequenceNumber=""1"" ServerName=""lab-dmann"" StatusId=""2"" StatusName=""Active"" WorkflowActivityId=""a57638ce-128f-4a03-91e4-0aa16f3fbae0""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""2"" ActionTypeName=""Custom action"" ApplyFullValidation=""False"" CategoryId=""2005"" CategoryName=""IIS"" DeployerToolId=""0"" DeploymentMethod=""2013"" Description=""Start a web site (IIS 7.0+)"" HasPendingSecurityChanges=""False"" Id=""3962"" InMemoryStatus=""New"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""True"" IsSerializing=""False"" Name=""Start Web Site"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""4"" TypeName=""Without source"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID1"" Id=""9878"" Name=""SiteName"" Value=""bar"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID1</x:Reference></ActionActivity.StageActivityVariables><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></ActionActivity></RollbackActivity><ComponentActivity DisplayName=""Daniel Web Site Component"" sap:VirtualizedContainerService.HintSize=""353.6,118.4"" IsSkipped=""True"" WorkflowActivityId=""2abb2d8e-21e7-4829-a426-339d3d7971ae""><ComponentActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Daniel Web Site Component"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""4033"" HasPendingSecurityChanges=""False"" Id=""-910621"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""0"" LinkedV2ComponentId=""0"" ServerId=""19"" ServerInstanceSequenceNumber=""1"" ServerName=""lab-dmann"" StatusId=""2"" StatusName=""Active"" WorkflowActivityId=""2abb2d8e-21e7-4829-a426-339d3d7971ae""><mtrdm:StageActivity.Component><mtrdm:ApplicationVersionComponent Id=""4033"" InMemoryStatus=""Existing"" Name=""Daniel Web Site Component"" OverrideRelativePathToPackageLocation=""""><mtrdm:ApplicationVersionComponent.ConfigurationVariables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID2"" Id=""10075"" Name=""Installation Path"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID3"" Id=""10087"" Name=""ConfigVariable1"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID4"" Id=""10088"" Name=""EncryptedConfigVariable"" Value="""" /></mtrdm:ApplicationVersionComponent.ConfigurationVariables><mtrdm:ApplicationVersionComponent.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:ApplicationVersionComponent.PropertyBagVariables></mtrdm:ApplicationVersionComponent></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID5"" Id=""10075"" Name=""Installation Path"" Value=""a"" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID6"" Id=""10087"" Name=""ConfigVariable1"" Value=""b"" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID7"" Id=""10088"" Name=""EncryptedConfigVariable"" Value=""c"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ComponentActivity.StageActivity><ComponentActivity.StageActivityVariables><x:Reference>__ReferenceID5</x:Reference><x:Reference>__ReferenceID6</x:Reference><x:Reference>__ReferenceID7</x:Reference></ComponentActivity.StageActivityVariables><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></ComponentActivity><RollbackAlwaysActivity DisplayName=""Rollback Always"" sap:VirtualizedContainerService.HintSize=""353.6,206.4""><ActionActivity DisplayName=""Start Application Pool"" sap:VirtualizedContainerService.HintSize=""318.4,81.6"" IsSkipped=""False"" WorkflowActivityId=""5c61c0d4-f1df-466c-8456-3c07ae6fa4e2""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Start Application Pool"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3966"" HasPendingSecurityChanges=""False"" Id=""-677535"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""0"" LinkedV2ComponentId=""0"" ServerId=""19"" ServerInstanceSequenceNumber=""1"" ServerName=""lab-dmann"" StatusId=""2"" StatusName=""Active"" WorkflowActivityId=""5c61c0d4-f1df-466c-8456-3c07ae6fa4e2""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""2"" ActionTypeName=""Custom action"" ApplyFullValidation=""False"" CategoryId=""2005"" CategoryName=""IIS"" DeployerToolId=""0"" DeploymentMethod=""2013"" Description=""Start an application pool (IIS 7.0+)"" HasPendingSecurityChanges=""False"" Id=""3966"" InMemoryStatus=""New"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""True"" IsSerializing=""False"" Name=""Start Application Pool"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""4"" TypeName=""Without source"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID8"" Id=""9890"" Name=""AppPoolName"" Value=""baz"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID8</x:Reference></ActionActivity.StageActivityVariables><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></ActionActivity></RollbackAlwaysActivity></ServerActivity></DeploymentSequenceActivity>";

            // Act
            var sequence = (new RMDeploymentSequence { StageId = 100, WorkflowXaml = testXml }).ToReleaseTemplate();

            // Assert
            var servers = sequence.Containers.ToList();
            var actions = servers[0].SubItems.ToList();
            var rollback = actions[3] as RollbackBlock;
            Assert.IsNotNull(rollback);
            Assert.AreEqual(1, rollback.SubItems.Count());
            Assert.AreEqual("Start Application Pool", rollback.SubItems.First().DisplayName);
            Assert.AreEqual(3966, rollback.SubItems.Cast<ReleaseAction>().First().ComponentId);
        }

        [TestMethod]
        public void Can_Parse_A_Rollback_Block()
        {
            // Arrange
            var testXml =
                @"<DeploymentSequenceActivity xmlns=""clr-namespace:Microsoft.TeamFoundation.Release.Workflow.Activities;assembly=Microsoft.TeamFoundation.Release.Workflow"" xmlns:mtrdm=""clr-namespace:Microsoft.TeamFoundation.Release.Data.Model;assembly=Microsoft.TeamFoundation.Release.Data"" xmlns:mva=""clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"" xmlns:p=""http://schemas.microsoft.com/netfx/2009/xaml/activities"" xmlns:sap=""http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"" xmlns:scg=""clr-namespace:System.Collections.Generic;assembly=mscorlib"" xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml"" DisplayName=""Deployment Sequence"" sap:VirtualizedContainerService.HintSize=""398.4,982.4"" mva:VisualBasic.Settings=""Assembly references and imported namespaces serialized as XML namespaces""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><ServerActivity sap:VirtualizedContainerService.HintSize=""376,857.6"" InstanceSequenceNumber=""1"" ServerId=""19"" ServerName=""lab-dmann""><ActionActivity DisplayName=""Stop Web Site"" sap:VirtualizedContainerService.HintSize=""353.6,81.6"" IsSkipped=""False"" WorkflowActivityId=""8b6c8817-e7a0-404f-b265-a5bf36e96b88""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Stop Web Site"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3963"" HasPendingSecurityChanges=""False"" Id=""-69607"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""0"" LinkedV2ComponentId=""0"" ServerId=""19"" ServerInstanceSequenceNumber=""1"" ServerName=""lab-dmann"" StatusId=""2"" StatusName=""Active"" WorkflowActivityId=""8b6c8817-e7a0-404f-b265-a5bf36e96b88""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""2"" ActionTypeName=""Custom action"" ApplyFullValidation=""False"" CategoryId=""2005"" CategoryName=""IIS"" DeployerToolId=""0"" DeploymentMethod=""2013"" Description=""Stop a web site (IIS 7.0+)"" HasPendingSecurityChanges=""False"" Id=""3963"" InMemoryStatus=""New"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""True"" IsSerializing=""False"" Name=""Stop Web Site"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""4"" TypeName=""Without source"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID0"" Id=""9879"" Name=""SiteName"" Value=""placeholder"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID0</x:Reference></ActionActivity.StageActivityVariables><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></ActionActivity><RollbackActivity DisplayName=""Rollback"" sap:VirtualizedContainerService.HintSize=""353.6,206.4""><ActionActivity DisplayName=""Start Web Site"" sap:VirtualizedContainerService.HintSize=""318.4,81.6"" IsSkipped=""False"" WorkflowActivityId=""a57638ce-128f-4a03-91e4-0aa16f3fbae0""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Start Web Site"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3962"" HasPendingSecurityChanges=""False"" Id=""-302956"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""0"" LinkedV2ComponentId=""0"" ServerId=""19"" ServerInstanceSequenceNumber=""1"" ServerName=""lab-dmann"" StatusId=""2"" StatusName=""Active"" WorkflowActivityId=""a57638ce-128f-4a03-91e4-0aa16f3fbae0""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""2"" ActionTypeName=""Custom action"" ApplyFullValidation=""False"" CategoryId=""2005"" CategoryName=""IIS"" DeployerToolId=""0"" DeploymentMethod=""2013"" Description=""Start a web site (IIS 7.0+)"" HasPendingSecurityChanges=""False"" Id=""3962"" InMemoryStatus=""New"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""True"" IsSerializing=""False"" Name=""Start Web Site"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""4"" TypeName=""Without source"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID1"" Id=""9878"" Name=""SiteName"" Value=""bar"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID1</x:Reference></ActionActivity.StageActivityVariables><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></ActionActivity></RollbackActivity><ComponentActivity DisplayName=""Daniel Web Site Component"" sap:VirtualizedContainerService.HintSize=""353.6,118.4"" IsSkipped=""True"" WorkflowActivityId=""2abb2d8e-21e7-4829-a426-339d3d7971ae""><ComponentActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Daniel Web Site Component"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""4033"" HasPendingSecurityChanges=""False"" Id=""-910621"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""0"" LinkedV2ComponentId=""0"" ServerId=""19"" ServerInstanceSequenceNumber=""1"" ServerName=""lab-dmann"" StatusId=""2"" StatusName=""Active"" WorkflowActivityId=""2abb2d8e-21e7-4829-a426-339d3d7971ae""><mtrdm:StageActivity.Component><mtrdm:ApplicationVersionComponent Id=""4033"" InMemoryStatus=""Existing"" Name=""Daniel Web Site Component"" OverrideRelativePathToPackageLocation=""""><mtrdm:ApplicationVersionComponent.ConfigurationVariables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID2"" Id=""10075"" Name=""Installation Path"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID3"" Id=""10087"" Name=""ConfigVariable1"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID4"" Id=""10088"" Name=""EncryptedConfigVariable"" Value="""" /></mtrdm:ApplicationVersionComponent.ConfigurationVariables><mtrdm:ApplicationVersionComponent.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:ApplicationVersionComponent.PropertyBagVariables></mtrdm:ApplicationVersionComponent></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID5"" Id=""10075"" Name=""Installation Path"" Value=""a"" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID6"" Id=""10087"" Name=""ConfigVariable1"" Value=""b"" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID7"" Id=""10088"" Name=""EncryptedConfigVariable"" Value=""c"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ComponentActivity.StageActivity><ComponentActivity.StageActivityVariables><x:Reference>__ReferenceID5</x:Reference><x:Reference>__ReferenceID6</x:Reference><x:Reference>__ReferenceID7</x:Reference></ComponentActivity.StageActivityVariables><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></ComponentActivity><RollbackAlwaysActivity DisplayName=""Rollback Always"" sap:VirtualizedContainerService.HintSize=""353.6,206.4""><ActionActivity DisplayName=""Start Application Pool"" sap:VirtualizedContainerService.HintSize=""318.4,81.6"" IsSkipped=""False"" WorkflowActivityId=""5c61c0d4-f1df-466c-8456-3c07ae6fa4e2""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Start Application Pool"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3966"" HasPendingSecurityChanges=""False"" Id=""-677535"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""0"" LinkedV2ComponentId=""0"" ServerId=""19"" ServerInstanceSequenceNumber=""1"" ServerName=""lab-dmann"" StatusId=""2"" StatusName=""Active"" WorkflowActivityId=""5c61c0d4-f1df-466c-8456-3c07ae6fa4e2""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""2"" ActionTypeName=""Custom action"" ApplyFullValidation=""False"" CategoryId=""2005"" CategoryName=""IIS"" DeployerToolId=""0"" DeploymentMethod=""2013"" Description=""Start an application pool (IIS 7.0+)"" HasPendingSecurityChanges=""False"" Id=""3966"" InMemoryStatus=""New"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""True"" IsSerializing=""False"" Name=""Start Application Pool"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""4"" TypeName=""Without source"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID8"" Id=""9890"" Name=""AppPoolName"" Value=""baz"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID8</x:Reference></ActionActivity.StageActivityVariables><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></ActionActivity></RollbackAlwaysActivity></ServerActivity></DeploymentSequenceActivity>";

            // Act
            var sequence = (new RMDeploymentSequence { StageId = 100, WorkflowXaml = testXml }).ToReleaseTemplate();

            // Assert
            var servers = sequence.Containers.ToList();
            var actions = servers[0].SubItems.ToList();
            var rollback = actions[1] as RollbackBlock;
            Assert.IsNotNull(rollback);
            Assert.AreEqual(1, rollback.SubItems.Count());
            Assert.AreEqual("Start Web Site", rollback.SubItems.First().DisplayName);
            Assert.AreEqual(3962, rollback.SubItems.Cast<ReleaseAction>().First().ComponentId);
        }

        [TestMethod]
        public void Can_Parse_An_Action_In_A_Server_Element()
        {
            // Arrange
            var testXml =
                @"<DeploymentSequenceActivity xmlns=""clr-namespace:Microsoft.TeamFoundation.Release.Workflow.Activities;assembly=Microsoft.TeamFoundation.Release.Workflow"" xmlns:mtrdm=""clr-namespace:Microsoft.TeamFoundation.Release.Data.Model;assembly=Microsoft.TeamFoundation.Release.Data"" xmlns:mva=""clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"" xmlns:p=""http://schemas.microsoft.com/netfx/2009/xaml/activities"" xmlns:sap=""http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"" xmlns:scg=""clr-namespace:System.Collections.Generic;assembly=mscorlib"" xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml"" DisplayName=""Deployment Sequence"" sap:VirtualizedContainerService.HintSize=""244.8,302.4"" mva:VisualBasic.Settings=""Assembly references and imported namespaces serialized as XML namespaces""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><ServerActivity sap:VirtualizedContainerService.HintSize=""222.4,177.6"" InstanceSequenceNumber=""1"" ServerId=""19"" ServerName=""lab-dmann""><ActionActivity DisplayName=""Copy File or Folder"" sap:VirtualizedContainerService.HintSize=""200,52.8"" IsSkipped=""False"" WorkflowActivityId=""a122e31d-9faa-4468-b09b-2ec09ea51567""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Copy File or Folder"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3981"" HasPendingSecurityChanges=""False"" Id=""-835378"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""0"" LinkedV2ComponentId=""0"" ServerId=""19"" ServerInstanceSequenceNumber=""1"" ServerName=""lab-dmann"" StatusId=""2"" StatusName=""Active"" WorkflowActivityId=""a122e31d-9faa-4468-b09b-2ec09ea51567""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""2"" ActionTypeName=""Custom action"" ApplyFullValidation=""False"" CategoryId=""1998"" CategoryName=""Windows OS"" DeployerToolId=""0"" DeploymentMethod=""2013"" Description=""Copy file(s) or folder (wildcards can be used)"" HasPendingSecurityChanges=""False"" Id=""3981"" InMemoryStatus=""New"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""True"" IsSerializing=""False"" Name=""Copy File or Folder"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""4"" TypeName=""Without source"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID0"" Id=""9950"" Name=""SourceFileFolder"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID1"" Id=""9951"" Name=""DestinationFileFolder"" Value="""" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID0</x:Reference><x:Reference>__ReferenceID1</x:Reference></ActionActivity.StageActivityVariables></ActionActivity></ServerActivity></DeploymentSequenceActivity>";

            // Act
            var sequence = (new RMDeploymentSequence { StageId = 100, WorkflowXaml = testXml }).ToReleaseTemplate();

            // Assert
            var servers = sequence.Containers.ToList();
            var actions = servers[0].SubItems.Cast<ReleaseAction>().ToList();
            Assert.AreEqual(1, servers.Count);
            Assert.AreEqual(1, actions.Count);

            Assert.AreEqual("Copy File or Folder", actions[0].DisplayName);
            Assert.AreEqual(3981, actions[0].ComponentId);
        }

        [TestMethod]
        public void Can_Parse_An_Action_In_A_Server_Tag_Element()
        {
            // Arrange
            var testXml =
                @"<DeploymentSequenceActivity xmlns=""clr-namespace:Microsoft.TeamFoundation.Release.Workflow.Activities;assembly=Microsoft.TeamFoundation.Release.Workflow"" xmlns:mtrdm=""clr-namespace:Microsoft.TeamFoundation.Release.Data.Model;assembly=Microsoft.TeamFoundation.Release.Data"" xmlns:mva=""clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"" xmlns:p=""http://schemas.microsoft.com/netfx/2009/xaml/activities"" xmlns:sap=""http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"" xmlns:scg=""clr-namespace:System.Collections.Generic;assembly=mscorlib"" xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml"" DisplayName=""Deployment Sequence"" sap:VirtualizedContainerService.HintSize=""244.8,302.4"" mva:VisualBasic.Settings=""Assembly references and imported namespaces serialized as XML namespaces""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><ServerTagActivity ExecutionMode=""1"" sap:VirtualizedContainerService.HintSize=""222.4,177.6"" InstanceSequenceNumber=""1"" TagName=""placeholder""><ActionActivity DisplayName=""Copy File or Folder"" sap:VirtualizedContainerService.HintSize=""200,52.8"" IsSkipped=""False"" WorkflowActivityId=""1f899e97-1e4f-460d-bca8-23b4c8222199""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Copy File or Folder"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3981"" HasPendingSecurityChanges=""False"" Id=""-781218"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""1"" LinkedV2ComponentId=""0"" Name=""placeholder"" ServerId=""0"" ServerInstanceSequenceNumber=""1"" StatusId=""2"" StatusName=""Active"" TagName=""placeholder"" WorkflowActivityId=""1f899e97-1e4f-460d-bca8-23b4c8222199""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""1"" ApplyFullValidation=""False"" Arguments=""&quot;__SourceFileFolder__&quot; &quot;__DestinationFileFolder__&quot;"" CategoryId=""1998"" CategoryName=""Windows OS"" Command=""irxcopy.cmd"" DeployerToolId=""12"" DeploymentMethod=""2013"" Description=""Copy file(s) or folder (wildcards can be used)"" HasPendingSecurityChanges=""False"" Id=""3981"" InMemoryStatus=""Existing"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""False"" IsSerializing=""False"" Name=""Copy File or Folder"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""3"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID0"" Id=""9950"" Name=""SourceFileFolder"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID1"" Id=""9951"" Name=""DestinationFileFolder"" Value="""" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID2"" Id=""9950"" Name=""SourceFileFolder"" Value=""C:\Source\"" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID3"" Id=""9951"" Name=""DestinationFileFolder"" Value=""C:\Dest\"" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID2</x:Reference><x:Reference>__ReferenceID3</x:Reference></ActionActivity.StageActivityVariables></ActionActivity></ServerTagActivity></DeploymentSequenceActivity>";

            // Act
            var sequence = (new RMDeploymentSequence { StageId = 100, WorkflowXaml = testXml }).ToReleaseTemplate();

            // Assert
            var servers = sequence.Containers.ToList();
            var actions = servers[0].SubItems.Cast<ReleaseAction>().ToList();
            Assert.AreEqual(1, servers.Count);
            Assert.AreEqual(1, actions.Count);

            Assert.AreEqual("Copy File or Folder", actions[0].DisplayName);
            Assert.AreEqual(Guid.Parse("1f899e97-1e4f-460d-bca8-23b4c8222199"), actions[0].WorkflowActivityId);
            Assert.AreEqual(3981, actions[0].ComponentId);
            Assert.IsTrue(actions[0].Enabled);
        }

        [TestMethod]
        public void Event_Fires_When_Action_Is_Parsed()
        {
            // Arrange
            var testXml =
                @"<DeploymentSequenceActivity xmlns=""clr-namespace:Microsoft.TeamFoundation.Release.Workflow.Activities;assembly=Microsoft.TeamFoundation.Release.Workflow"" xmlns:mtrdm=""clr-namespace:Microsoft.TeamFoundation.Release.Data.Model;assembly=Microsoft.TeamFoundation.Release.Data"" xmlns:mva=""clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"" xmlns:p=""http://schemas.microsoft.com/netfx/2009/xaml/activities"" xmlns:sap=""http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"" xmlns:scg=""clr-namespace:System.Collections.Generic;assembly=mscorlib"" xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml"" DisplayName=""Deployment Sequence"" sap:VirtualizedContainerService.HintSize=""244.8,302.4"" mva:VisualBasic.Settings=""Assembly references and imported namespaces serialized as XML namespaces""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><ServerActivity sap:VirtualizedContainerService.HintSize=""222.4,177.6"" InstanceSequenceNumber=""1"" ServerId=""19"" ServerName=""lab-dmann""><ActionActivity DisplayName=""Copy File or Folder"" sap:VirtualizedContainerService.HintSize=""200,52.8"" IsSkipped=""False"" WorkflowActivityId=""a122e31d-9faa-4468-b09b-2ec09ea51567""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Copy File or Folder"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3981"" HasPendingSecurityChanges=""False"" Id=""-835378"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""0"" LinkedV2ComponentId=""0"" ServerId=""19"" ServerInstanceSequenceNumber=""1"" ServerName=""lab-dmann"" StatusId=""2"" StatusName=""Active"" WorkflowActivityId=""a122e31d-9faa-4468-b09b-2ec09ea51567""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""2"" ActionTypeName=""Custom action"" ApplyFullValidation=""False"" CategoryId=""1998"" CategoryName=""Windows OS"" DeployerToolId=""0"" DeploymentMethod=""2013"" Description=""Copy file(s) or folder (wildcards can be used)"" HasPendingSecurityChanges=""False"" Id=""3981"" InMemoryStatus=""New"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""True"" IsSerializing=""False"" Name=""Copy File or Folder"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""4"" TypeName=""Without source"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID0"" Id=""9950"" Name=""SourceFileFolder"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID1"" Id=""9951"" Name=""DestinationFileFolder"" Value="""" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID0</x:Reference><x:Reference>__ReferenceID1</x:Reference></ActionActivity.StageActivityVariables></ActionActivity></ServerActivity></DeploymentSequenceActivity>";
            var eventFired = false;

            ActionParser.ActionParsed += (sender, args) =>
                {
                    Assert.AreEqual("Copy File or Folder", args.DisplayName);
                    Assert.AreEqual(BlockType.Action, args.ItemType);
                    eventFired = true;
                };

            // Act
            (new RMDeploymentSequence { StageId = 100, WorkflowXaml = testXml }).ToReleaseTemplate();
            Assert.IsTrue(eventFired);
        }

        [TestMethod]
        public void Event_Fires_When_Manual_Intervention_Is_Parsed()
        {
            // Arrange
            var testXml =
                @"<DeploymentSequenceActivity xmlns=""clr-namespace:Microsoft.TeamFoundation.Release.Workflow.Activities;assembly=Microsoft.TeamFoundation.Release.Workflow"" xmlns:mtrdm=""clr-namespace:Microsoft.TeamFoundation.Release.Data.Model;assembly=Microsoft.TeamFoundation.Release.Data"" xmlns:mva=""clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"" xmlns:p=""http://schemas.microsoft.com/netfx/2009/xaml/activities"" xmlns:sap=""http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"" xmlns:scg=""clr-namespace:System.Collections.Generic;assembly=mscorlib"" xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml"" DisplayName=""Deployment Sequence"" sap:VirtualizedContainerService.HintSize=""385.6,1801.6"" IsStageEditable=""True"" mva:VisualBasic.Settings=""Assembly references and imported namespaces serialized as XML namespaces""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><ServerTagActivity ExecutionMode=""1"" sap:VirtualizedContainerService.HintSize=""363.2,1676.8"" InstanceSequenceNumber=""1"" TagName=""placeholder""><ManualInterventionActivity Details=""Text text text&#xA;&#xA;More text&#xA;&#xA;Lots more text!!"" DisplayName=""My Wonderful Manual Intervention"" sap:VirtualizedContainerService.HintSize=""340.8,236.8"" Recipient=""1:9052"" WorkflowActivityId=""c5b00a78-aedf-4def-8c3b-e7030f972a59"" /></ServerTagActivity></DeploymentSequenceActivity>";
            var eventFired = false;

            ActionParser.ActionParsed += (sender, args) =>
                {
                    Assert.AreEqual("My Wonderful Manual Intervention", args.DisplayName);
                    Assert.AreEqual(BlockType.ManualIntervention, args.ItemType);
                    eventFired = true;
                };

            // Act
            (new RMDeploymentSequence { StageId = 100, WorkflowXaml = testXml }).ToReleaseTemplate();
            Assert.IsTrue(eventFired);
        }

        [TestMethod]
        public void Event_Fires_When_Rollback_Is_Parsed()
        {
            // Arrange
            var testXml =
                @"<DeploymentSequenceActivity xmlns=""clr-namespace:Microsoft.TeamFoundation.Release.Workflow.Activities;assembly=Microsoft.TeamFoundation.Release.Workflow"" xmlns:mtrdm=""clr-namespace:Microsoft.TeamFoundation.Release.Data.Model;assembly=Microsoft.TeamFoundation.Release.Data"" xmlns:mva=""clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"" xmlns:p=""http://schemas.microsoft.com/netfx/2009/xaml/activities"" xmlns:sap=""http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"" xmlns:scg=""clr-namespace:System.Collections.Generic;assembly=mscorlib"" xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml"" DisplayName=""Deployment Sequence"" sap:VirtualizedContainerService.HintSize=""385.6,1801.6"" IsStageEditable=""True"" mva:VisualBasic.Settings=""Assembly references and imported namespaces serialized as XML namespaces""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><ServerTagActivity ExecutionMode=""1"" sap:VirtualizedContainerService.HintSize=""363.2,1676.8"" InstanceSequenceNumber=""1"" TagName=""placeholder""><RollbackActivity DisplayName=""Rollback"" sap:VirtualizedContainerService.HintSize=""340.8,60.8""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">False</x:Boolean><x:Boolean x:Key=""IsPinned"">False</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState></RollbackActivity></ServerTagActivity></DeploymentSequenceActivity>";
            var eventFired = false;

            ActionParser.ActionParsed += (sender, args) =>
                {
                    Assert.AreEqual("Rollback", args.DisplayName);
                    Assert.AreEqual(BlockType.Rollback, args.ItemType);
                    eventFired = true;
                };

            // Act
            (new RMDeploymentSequence { StageId = 100, WorkflowXaml = testXml }).ToReleaseTemplate();
            Assert.IsTrue(eventFired);
        }

        [TestCleanup]
        public void TestCleanup()
        {
            ActionParser.ActionParsed = null;
        }
    }
}