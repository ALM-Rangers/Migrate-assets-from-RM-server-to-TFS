// --------------------------------------------------------------------------------------------------------------------
// <copyright file="When_Parsing_Release_Template_Workflow_Deployment_Sequences.cs" company="Microsoft Corporation">
//   Copyright Microsoft Corporation. All Rights Reserved. This code released under the terms of the MIT License (MIT, https://github.com/ALM-Rangers/Migrate-assets-from-RM-server-to-VSO/blob/master/License.txt). This is sample code only, do not use in production environments.
// </copyright>
// --------------------------------------------------------------------------------------------------------------------

 // ReSharper disable InconsistentNaming

namespace Microsoft.ALMRangers.RMWorkflowMigrator.Tests.Unit
{
    using System.Diagnostics.CodeAnalysis;
    using System.Linq;

    using Microsoft.ALMRangers.RMWorkflowMigrator.DataAccess.Model;
    using Microsoft.ALMRangers.RMWorkflowMigrator.Parser;
    using Microsoft.ALMRangers.RMWorkflowMigrator.Parser.Model;
    using Microsoft.VisualStudio.TestTools.UnitTesting;

    [ExcludeFromCodeCoverage]
    [TestClass]
    public class When_Parsing_Release_Template_Workflow_Deployment_Sequences
    {
        [TestMethod]
        public void Can_Parse_A_Deployment_Sequence_With_An_Empty_Inner_Sequence()
        {
            // Arrange
            var testXml =
                @"<DeploymentSequenceActivity xmlns=""clr-namespace:Microsoft.TeamFoundation.Release.Workflow.Activities;assembly=Microsoft.TeamFoundation.Release.Workflow"" xmlns:mva=""clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"" xmlns:p=""http://schemas.microsoft.com/netfx/2009/xaml/activities"" xmlns:sap=""http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"" xmlns:scg=""clr-namespace:System.Collections.Generic;assembly=mscorlib"" xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml"" DisplayName=""Deployment Sequence"" sap:VirtualizedContainerService.HintSize=""222.4,225.6"" mva:VisualBasic.Settings=""Assembly references and imported namespaces serialized as XML namespaces""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><p:Sequence DisplayName=""Test Sequence"" sap:VirtualizedContainerService.HintSize=""200,100.8"" /></DeploymentSequenceActivity>";

            // Act
            var sequence = (new RMDeploymentSequence { StageId = 100, WorkflowXaml = testXml }).ToReleaseTemplate();

            // Assert
            var container = sequence.Containers.ToList();

            Assert.AreEqual(1, container.Count);
            Assert.AreEqual("Test Sequence", container.First().DisplayName);
        }

        [TestMethod]
        public void Can_Parse_A_Deployment_Sequence_With_Multiple_Empty_Inner_Sequences()
        {
            // Arrange
            var testXml =
                @"<DeploymentSequenceActivity xmlns=""clr-namespace:Microsoft.TeamFoundation.Release.Workflow.Activities;assembly=Microsoft.TeamFoundation.Release.Workflow"" xmlns:mva=""clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"" xmlns:p=""http://schemas.microsoft.com/netfx/2009/xaml/activities"" xmlns:sap=""http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"" xmlns:scg=""clr-namespace:System.Collections.Generic;assembly=mscorlib"" xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml"" DisplayName=""Deployment Sequence"" sap:VirtualizedContainerService.HintSize=""222.4,366.4"" mva:VisualBasic.Settings=""Assembly references and imported namespaces serialized as XML namespaces""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><p:Sequence DisplayName=""Test Sequence"" sap:VirtualizedContainerService.HintSize=""200,100.8"" /><p:Sequence DisplayName=""Sequence"" sap:VirtualizedContainerService.HintSize=""200,100.8"" /></DeploymentSequenceActivity>";

            // Act
            var sequence = (new RMDeploymentSequence { StageId = 100, WorkflowXaml = testXml }).ToReleaseTemplate();

            // Assert
            Assert.IsNotNull(sequence.Containers);
            Assert.AreEqual(2, sequence.Containers.Count());

            Assert.AreEqual("Test Sequence", sequence.Containers.First().DisplayName);
            Assert.AreEqual(BlockType.Sequence, sequence.Containers.First().ItemType);
            Assert.AreEqual("Sequence", sequence.Containers.Last().DisplayName);
        }

        [TestMethod]
        public void Can_Parse_A_Deployment_Sequence_With_Multiple_Parallel_Blocks()
        {
            // Arrange
            var testXml =
                @"<DeploymentSequenceActivity xmlns=""clr-namespace:Microsoft.TeamFoundation.Release.Workflow.Activities;assembly=Microsoft.TeamFoundation.Release.Workflow"" xmlns:mtrdm=""clr-namespace:Microsoft.TeamFoundation.Release.Data.Model;assembly=Microsoft.TeamFoundation.Release.Data"" xmlns:mva=""clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"" xmlns:p=""http://schemas.microsoft.com/netfx/2009/xaml/activities"" xmlns:sap=""http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"" xmlns:scg=""clr-namespace:System.Collections.Generic;assembly=mscorlib"" xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml"" DisplayName=""Deployment Sequence"" sap:VirtualizedContainerService.HintSize=""222.4,369.6"" mva:VisualBasic.Settings=""Assembly references and imported namespaces serialized as XML namespaces""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><p:Parallel DisplayName=""Parallel"" sap:VirtualizedContainerService.HintSize=""200,102.4"" /><p:Parallel DisplayName=""Parallel 2"" sap:VirtualizedContainerService.HintSize=""200,102.4"" /></DeploymentSequenceActivity>";

            // Act
            var sequence = (new RMDeploymentSequence { StageId = 100, WorkflowXaml = testXml }).ToReleaseTemplate();

            // Assert
            var containers = sequence.Containers.ToList();

            Assert.AreEqual(2, containers.Count);
            Assert.AreEqual("Parallel", containers[0].DisplayName);
            Assert.AreEqual("Parallel 2", containers[1].DisplayName);
        }

        [TestMethod]
        public void Can_Parse_A_Deployment_Sequence_With_Multiple_Server_Tags()
        {
            // Arrange
            var testXml =
                @"<DeploymentSequenceActivity xmlns=""clr-namespace:Microsoft.TeamFoundation.Release.Workflow.Activities;assembly=Microsoft.TeamFoundation.Release.Workflow"" xmlns:mtrdm=""clr-namespace:Microsoft.TeamFoundation.Release.Data.Model;assembly=Microsoft.TeamFoundation.Release.Data"" xmlns:mva=""clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"" xmlns:p=""http://schemas.microsoft.com/netfx/2009/xaml/activities"" xmlns:sap=""http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"" xmlns:scg=""clr-namespace:System.Collections.Generic;assembly=mscorlib"" xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml"" DisplayName=""Deployment Sequence"" sap:VirtualizedContainerService.HintSize=""244.8,520"" mva:VisualBasic.Settings=""Assembly references and imported namespaces serialized as XML namespaces""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><ServerTagActivity ExecutionMode=""1"" sap:VirtualizedContainerService.HintSize=""222.4,177.6"" InstanceSequenceNumber=""1"" TagName=""placeholder""><ActionActivity DisplayName=""Start Service"" sap:VirtualizedContainerService.HintSize=""200,52.8"" IsSkipped=""False"" WorkflowActivityId=""cfa898b7-299b-4b2b-936b-0049165e5e8c""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Start Service"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3989"" HasPendingSecurityChanges=""False"" Id=""-386839"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""1"" LinkedV2ComponentId=""0"" Name=""placeholder"" ServerId=""0"" ServerInstanceSequenceNumber=""1"" StatusId=""2"" StatusName=""Active"" TagName=""placeholder"" WorkflowActivityId=""cfa898b7-299b-4b2b-936b-0049165e5e8c""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""2"" ActionTypeName=""Custom action"" ApplyFullValidation=""False"" CategoryId=""1999"" CategoryName=""Windows Services"" DeployerToolId=""0"" DeploymentMethod=""2013"" Description=""Start a Windows Service"" HasPendingSecurityChanges=""False"" Id=""3989"" InMemoryStatus=""New"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""True"" IsSerializing=""False"" Name=""Start Service"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""4"" TypeName=""Without source"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID0"" Id=""9969"" Name=""ServiceName"" Value="""" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID0</x:Reference></ActionActivity.StageActivityVariables></ActionActivity></ServerTagActivity><ServerTagActivity ExecutionMode=""1"" sap:VirtualizedContainerService.HintSize=""222.4,177.6"" InstanceSequenceNumber=""1"" TagName=""Bar""><ActionActivity DisplayName=""Stop Service"" sap:VirtualizedContainerService.HintSize=""200,52.8"" IsSkipped=""False"" WorkflowActivityId=""7840bbe2-c0f9-45fb-9b1d-b3d67bdf1552""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Stop Service"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3991"" HasPendingSecurityChanges=""False"" Id=""-410294"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""1"" LinkedV2ComponentId=""0"" Name=""Bar"" ServerId=""0"" ServerInstanceSequenceNumber=""1"" StatusId=""2"" StatusName=""Active"" TagName=""Bar"" WorkflowActivityId=""7840bbe2-c0f9-45fb-9b1d-b3d67bdf1552""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""2"" ActionTypeName=""Custom action"" ApplyFullValidation=""False"" CategoryId=""1999"" CategoryName=""Windows Services"" DeployerToolId=""0"" DeploymentMethod=""2013"" Description=""Stop a Windows Service"" HasPendingSecurityChanges=""False"" Id=""3991"" InMemoryStatus=""New"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""True"" IsSerializing=""False"" Name=""Stop Service"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""4"" TypeName=""Without source"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID1"" Id=""9971"" Name=""ServiceName"" Value="""" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID1</x:Reference></ActionActivity.StageActivityVariables></ActionActivity></ServerTagActivity></DeploymentSequenceActivity>";

            // Act
            var sequence = (new RMDeploymentSequence { StageId = 100, WorkflowXaml = testXml }).ToReleaseTemplate();

            // Assert
            Assert.IsNotNull(sequence.Containers);
            Assert.AreEqual(2, sequence.Containers.Count());
            Assert.AreEqual("placeholder", sequence.Containers.First().DisplayName);
            Assert.AreEqual("Bar", sequence.Containers.Last().DisplayName);
        }

        [TestMethod]
        public void Can_Parse_A_Deployment_Sequence_With_Multiple_Single_Server_Containers()
        {
            // Arrange
            var testXml =
                @"<DeploymentSequenceActivity xmlns=""clr-namespace:Microsoft.TeamFoundation.Release.Workflow.Activities;assembly=Microsoft.TeamFoundation.Release.Workflow"" xmlns:mtrdm=""clr-namespace:Microsoft.TeamFoundation.Release.Data.Model;assembly=Microsoft.TeamFoundation.Release.Data"" xmlns:mva=""clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"" xmlns:p=""http://schemas.microsoft.com/netfx/2009/xaml/activities"" xmlns:sap=""http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"" xmlns:scg=""clr-namespace:System.Collections.Generic;assembly=mscorlib"" xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml"" DisplayName=""Deployment Sequence"" sap:VirtualizedContainerService.HintSize=""244.8,520"" mva:VisualBasic.Settings=""Assembly references and imported namespaces serialized as XML namespaces""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><ServerActivity sap:VirtualizedContainerService.HintSize=""222.4,177.6"" InstanceSequenceNumber=""1"" ServerId=""19"" ServerName=""lab-dmann""><ActionActivity DisplayName=""Configure Application Pool"" sap:VirtualizedContainerService.HintSize=""200,52.8"" IsSkipped=""False"" WorkflowActivityId=""423fd65e-506a-45c8-8db5-fd9d84e6d345""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Configure Application Pool"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3969"" HasPendingSecurityChanges=""False"" Id=""-601087"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""0"" LinkedV2ComponentId=""0"" ServerId=""19"" ServerInstanceSequenceNumber=""1"" ServerName=""lab-dmann"" StatusId=""2"" StatusName=""Active"" WorkflowActivityId=""423fd65e-506a-45c8-8db5-fd9d84e6d345""><mtrdm:StageActivity.Component><mtrdm:Component x:Name=""__ReferenceID13"" ActionTypeId=""2"" ActionTypeName=""Custom action"" ApplyFullValidation=""False"" CategoryId=""2005"" CategoryName=""IIS"" DeployerToolId=""0"" DeploymentMethod=""2013"" Description=""Configure an application pool (IIS 7.0+)"" HasPendingSecurityChanges=""False"" Id=""3969"" InMemoryStatus=""New"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""True"" IsSerializing=""False"" Name=""Configure Application Pool"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""4"" TypeName=""Without source"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID0"" Id=""9905"" Name=""AppPoolName"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID1"" Id=""9906"" Name=""Is32BitsAllowed"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID2"" Id=""9907"" Name=""IdentityUserDomain"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID3"" Id=""9908"" Name=""IdentityUserName"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID4"" Id=""9909"" Name=""IdentityUserPassword"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID5"" Id=""9910"" Name=""DotNetVersion"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID6"" Id=""9911"" Name=""PipeLineMode"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID7"" Id=""9912"" Name=""ProcessIdleTimeOut"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID8"" Id=""9913"" Name=""RecycleKbMemory"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID9"" Id=""9914"" Name=""RecycleAfterMinutes"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID10"" Id=""9915"" Name=""RecycleFixedTime"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID11"" Id=""9916"" Name=""StartMode"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID12"" Id=""9917"" Name=""IsAutoStart"" Value="""" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID0</x:Reference><x:Reference>__ReferenceID1</x:Reference><x:Reference>__ReferenceID2</x:Reference><x:Reference>__ReferenceID3</x:Reference><x:Reference>__ReferenceID4</x:Reference><x:Reference>__ReferenceID5</x:Reference><x:Reference>__ReferenceID6</x:Reference><x:Reference>__ReferenceID7</x:Reference><x:Reference>__ReferenceID8</x:Reference><x:Reference>__ReferenceID9</x:Reference><x:Reference>__ReferenceID10</x:Reference><x:Reference>__ReferenceID11</x:Reference><x:Reference>__ReferenceID12</x:Reference></ActionActivity.StageActivityVariables></ActionActivity></ServerActivity><ServerActivity sap:VirtualizedContainerService.HintSize=""222.4,177.6"" InstanceSequenceNumber=""2"" ServerId=""19"" ServerName=""lab-dmann2""><ActionActivity DisplayName=""Configure Application Pool"" sap:VirtualizedContainerService.HintSize=""200,52.8"" IsSkipped=""False"" WorkflowActivityId=""818883fa-3d2c-4fb4-8b89-2ca5b0d790fe""><ActionActivity.StageActivity><mtrdm:StageActivity Component=""{x:Reference __ReferenceID13}"" ActivityDisplayName=""Configure Application Pool"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3969"" HasPendingSecurityChanges=""False"" Id=""-259336"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""0"" LinkedV2ComponentId=""0"" ServerId=""19"" ServerInstanceSequenceNumber=""2"" ServerName=""lab-dmann2"" StatusId=""2"" StatusName=""Active"" WorkflowActivityId=""818883fa-3d2c-4fb4-8b89-2ca5b0d790fe""><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID14"" Id=""9905"" Name=""AppPoolName"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID15"" Id=""9906"" Name=""Is32BitsAllowed"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID16"" Id=""9907"" Name=""IdentityUserDomain"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID17"" Id=""9908"" Name=""IdentityUserName"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID18"" Id=""9909"" Name=""IdentityUserPassword"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID19"" Id=""9910"" Name=""DotNetVersion"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID20"" Id=""9911"" Name=""PipeLineMode"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID21"" Id=""9912"" Name=""ProcessIdleTimeOut"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID22"" Id=""9913"" Name=""RecycleKbMemory"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID23"" Id=""9914"" Name=""RecycleAfterMinutes"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID24"" Id=""9915"" Name=""RecycleFixedTime"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID25"" Id=""9916"" Name=""StartMode"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID26"" Id=""9917"" Name=""IsAutoStart"" Value="""" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID14</x:Reference><x:Reference>__ReferenceID15</x:Reference><x:Reference>__ReferenceID16</x:Reference><x:Reference>__ReferenceID17</x:Reference><x:Reference>__ReferenceID18</x:Reference><x:Reference>__ReferenceID19</x:Reference><x:Reference>__ReferenceID20</x:Reference><x:Reference>__ReferenceID21</x:Reference><x:Reference>__ReferenceID22</x:Reference><x:Reference>__ReferenceID23</x:Reference><x:Reference>__ReferenceID24</x:Reference><x:Reference>__ReferenceID25</x:Reference><x:Reference>__ReferenceID26</x:Reference></ActionActivity.StageActivityVariables></ActionActivity></ServerActivity></DeploymentSequenceActivity>";

            // Act
            var sequence = (new RMDeploymentSequence { StageId = 100, WorkflowXaml = testXml }).ToReleaseTemplate();

            // Assert
            Assert.IsNotNull(sequence.Containers);
            Assert.AreEqual(2, sequence.Containers.Count());
            Assert.AreEqual("lab-dmann", sequence.Containers.First().DisplayName);
            Assert.AreEqual("lab-dmann2", sequence.Containers.Last().DisplayName);
        }

        [TestMethod]
        public void Can_Parse_A_Deployment_Sequence_With_One_Single_Server_Container()
        {
            // Arrange
            var testXml =
                @"<DeploymentSequenceActivity xmlns=""clr-namespace:Microsoft.TeamFoundation.Release.Workflow.Activities;assembly=Microsoft.TeamFoundation.Release.Workflow"" xmlns:mtrdm=""clr-namespace:Microsoft.TeamFoundation.Release.Data.Model;assembly=Microsoft.TeamFoundation.Release.Data"" xmlns:mva=""clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"" xmlns:p=""http://schemas.microsoft.com/netfx/2009/xaml/activities"" xmlns:sap=""http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"" xmlns:scg=""clr-namespace:System.Collections.Generic;assembly=mscorlib"" xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml"" DisplayName=""Deployment Sequence"" sap:VirtualizedContainerService.HintSize=""244.8,302.4"" mva:VisualBasic.Settings=""Assembly references and imported namespaces serialized as XML namespaces""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><ServerActivity sap:VirtualizedContainerService.HintSize=""222.4,177.6"" InstanceSequenceNumber=""1"" ServerId=""19"" ServerName=""lab-dmann""><ActionActivity DisplayName=""Configure Application Pool"" sap:VirtualizedContainerService.HintSize=""200,52.8"" IsSkipped=""False"" WorkflowActivityId=""423fd65e-506a-45c8-8db5-fd9d84e6d345""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Configure Application Pool"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3969"" HasPendingSecurityChanges=""False"" Id=""1474"" IsDeletable=""True"" IsDirty=""False"" IsSerializing=""False"" IsTagBased=""0"" LinkedV2ComponentId=""0"" ServerId=""19"" ServerInstanceSequenceNumber=""1"" ServerName=""lab-dmann"" StatusId=""2"" StatusName=""Active"" WorkflowActivityId=""423fd65e-506a-45c8-8db5-fd9d84e6d345""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""1"" ApplyFullValidation=""False"" Arguments=""-ConfigureAppPool -ap &quot;__AppPoolName__&quot; -apAllow32Bit __Is32BitsAllowed__ -apidentuserdomain &quot;__IdentityUserDomain__&quot; -apidentusername &quot;__IdentityUserName__&quot; -apidentuserpassword &quot;__IdentityUserPassword__&quot; -apnetvers __DotNetVersion__ -appipelinemode __PipeLineMode__ -approcessidletimeout __ProcessIdleTimeOut__ -aprecyclekbmemory __RecycleKbMemory__ -aprecycleminutes __RecycleAfterMinutes__ -aprecyclespecifictime __RecycleFixedTime__ -apstartmode __StartMode__ -autostart __IsAutoStart__"" CategoryId=""2005"" CategoryName=""IIS"" Command=""IISConfig.exe"" DeployerToolId=""2014"" DeploymentMethod=""2013"" Description=""Configure an application pool (IIS 7.0+)"" HasPendingSecurityChanges=""False"" Id=""3969"" InMemoryStatus=""Existing"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""False"" IsSerializing=""False"" Name=""Configure Application Pool"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""3"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID0"" Id=""9905"" Name=""AppPoolName"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID1"" Id=""9906"" Name=""Is32BitsAllowed"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID2"" Id=""9907"" Name=""IdentityUserDomain"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID3"" Id=""9908"" Name=""IdentityUserName"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID4"" Id=""9909"" Name=""IdentityUserPassword"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID5"" Id=""9910"" Name=""DotNetVersion"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID6"" Id=""9911"" Name=""PipeLineMode"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID7"" Id=""9912"" Name=""ProcessIdleTimeOut"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID8"" Id=""9913"" Name=""RecycleKbMemory"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID9"" Id=""9914"" Name=""RecycleAfterMinutes"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID10"" Id=""9915"" Name=""RecycleFixedTime"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID11"" Id=""9916"" Name=""StartMode"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID12"" Id=""9917"" Name=""IsAutoStart"" Value="""" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID13"" Id=""9905"" Name=""AppPoolName"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID14"" Id=""9906"" Name=""Is32BitsAllowed"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID15"" Id=""9907"" Name=""IdentityUserDomain"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID16"" Id=""9908"" Name=""IdentityUserName"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID17"" Id=""9909"" Name=""IdentityUserPassword"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID18"" Id=""9910"" Name=""DotNetVersion"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID19"" Id=""9911"" Name=""PipeLineMode"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID20"" Id=""9912"" Name=""ProcessIdleTimeOut"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID21"" Id=""9913"" Name=""RecycleKbMemory"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID22"" Id=""9914"" Name=""RecycleAfterMinutes"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID23"" Id=""9915"" Name=""RecycleFixedTime"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID24"" Id=""9916"" Name=""StartMode"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID25"" Id=""9917"" Name=""IsAutoStart"" Value="""" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID13</x:Reference><x:Reference>__ReferenceID14</x:Reference><x:Reference>__ReferenceID15</x:Reference><x:Reference>__ReferenceID16</x:Reference><x:Reference>__ReferenceID17</x:Reference><x:Reference>__ReferenceID18</x:Reference><x:Reference>__ReferenceID19</x:Reference><x:Reference>__ReferenceID20</x:Reference><x:Reference>__ReferenceID21</x:Reference><x:Reference>__ReferenceID22</x:Reference><x:Reference>__ReferenceID23</x:Reference><x:Reference>__ReferenceID24</x:Reference><x:Reference>__ReferenceID25</x:Reference></ActionActivity.StageActivityVariables></ActionActivity></ServerActivity></DeploymentSequenceActivity>";

            // Act
            var sequence = (new RMDeploymentSequence { StageId = 100, WorkflowXaml = testXml }).ToReleaseTemplate();

            // Assert
            Assert.IsNotNull(sequence.Containers);
            Assert.AreEqual(1, sequence.Containers.Count());
            Assert.AreEqual("lab-dmann", sequence.Containers.First().DisplayName);
        }

        [TestMethod]
        public void Can_Parse_A_Deployment_Sequence_With_One_Single_Server_Container_Followed_By_One_Sequence()
        {
            // Arrange
            var testXml =
                @"<DeploymentSequenceActivity xmlns=""clr-namespace:Microsoft.TeamFoundation.Release.Workflow.Activities;assembly=Microsoft.TeamFoundation.Release.Workflow"" xmlns:mtrdm=""clr-namespace:Microsoft.TeamFoundation.Release.Data.Model;assembly=Microsoft.TeamFoundation.Release.Data"" xmlns:mva=""clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"" xmlns:p=""http://schemas.microsoft.com/netfx/2009/xaml/activities"" xmlns:sap=""http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"" xmlns:scg=""clr-namespace:System.Collections.Generic;assembly=mscorlib"" xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml"" DisplayName=""Deployment Sequence"" sap:VirtualizedContainerService.HintSize=""244.8,443.2"" mva:VisualBasic.Settings=""Assembly references and imported namespaces serialized as XML namespaces""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><ServerActivity sap:VirtualizedContainerService.HintSize=""222.4,177.6"" InstanceSequenceNumber=""1"" ServerId=""19"" ServerName=""lab-dmann""><ActionActivity DisplayName=""Configure Application Pool"" sap:VirtualizedContainerService.HintSize=""200,52.8"" IsSkipped=""False"" WorkflowActivityId=""423fd65e-506a-45c8-8db5-fd9d84e6d345""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Configure Application Pool"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3969"" HasPendingSecurityChanges=""False"" Id=""1476"" IsDeletable=""True"" IsDirty=""False"" IsSerializing=""False"" IsTagBased=""0"" LinkedV2ComponentId=""0"" ServerId=""19"" ServerInstanceSequenceNumber=""1"" ServerName=""lab-dmann"" StatusId=""2"" StatusName=""Active"" WorkflowActivityId=""423fd65e-506a-45c8-8db5-fd9d84e6d345""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""1"" ApplyFullValidation=""False"" Arguments=""-ConfigureAppPool -ap &quot;__AppPoolName__&quot; -apAllow32Bit __Is32BitsAllowed__ -apidentuserdomain &quot;__IdentityUserDomain__&quot; -apidentusername &quot;__IdentityUserName__&quot; -apidentuserpassword &quot;__IdentityUserPassword__&quot; -apnetvers __DotNetVersion__ -appipelinemode __PipeLineMode__ -approcessidletimeout __ProcessIdleTimeOut__ -aprecyclekbmemory __RecycleKbMemory__ -aprecycleminutes __RecycleAfterMinutes__ -aprecyclespecifictime __RecycleFixedTime__ -apstartmode __StartMode__ -autostart __IsAutoStart__"" CategoryId=""2005"" CategoryName=""IIS"" Command=""IISConfig.exe"" DeployerToolId=""2014"" DeploymentMethod=""2013"" Description=""Configure an application pool (IIS 7.0+)"" HasPendingSecurityChanges=""False"" Id=""3969"" InMemoryStatus=""Existing"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""False"" IsSerializing=""False"" Name=""Configure Application Pool"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""3"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID0"" Id=""9905"" Name=""AppPoolName"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID1"" Id=""9906"" Name=""Is32BitsAllowed"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID2"" Id=""9907"" Name=""IdentityUserDomain"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID3"" Id=""9908"" Name=""IdentityUserName"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID4"" Id=""9909"" Name=""IdentityUserPassword"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID5"" Id=""9910"" Name=""DotNetVersion"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID6"" Id=""9911"" Name=""PipeLineMode"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID7"" Id=""9912"" Name=""ProcessIdleTimeOut"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID8"" Id=""9913"" Name=""RecycleKbMemory"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID9"" Id=""9914"" Name=""RecycleAfterMinutes"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID10"" Id=""9915"" Name=""RecycleFixedTime"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID11"" Id=""9916"" Name=""StartMode"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID12"" Id=""9917"" Name=""IsAutoStart"" Value="""" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID13"" Id=""9905"" Name=""AppPoolName"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID14"" Id=""9906"" Name=""Is32BitsAllowed"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID15"" Id=""9907"" Name=""IdentityUserDomain"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID16"" Id=""9908"" Name=""IdentityUserName"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID17"" Id=""9909"" Name=""IdentityUserPassword"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID18"" Id=""9910"" Name=""DotNetVersion"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID19"" Id=""9911"" Name=""PipeLineMode"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID20"" Id=""9912"" Name=""ProcessIdleTimeOut"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID21"" Id=""9913"" Name=""RecycleKbMemory"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID22"" Id=""9914"" Name=""RecycleAfterMinutes"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID23"" Id=""9915"" Name=""RecycleFixedTime"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID24"" Id=""9916"" Name=""StartMode"" Value="""" /><mtrdm:ConfigurationVariable x:Name=""__ReferenceID25"" Id=""9917"" Name=""IsAutoStart"" Value="""" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID13</x:Reference><x:Reference>__ReferenceID14</x:Reference><x:Reference>__ReferenceID15</x:Reference><x:Reference>__ReferenceID16</x:Reference><x:Reference>__ReferenceID17</x:Reference><x:Reference>__ReferenceID18</x:Reference><x:Reference>__ReferenceID19</x:Reference><x:Reference>__ReferenceID20</x:Reference><x:Reference>__ReferenceID21</x:Reference><x:Reference>__ReferenceID22</x:Reference><x:Reference>__ReferenceID23</x:Reference><x:Reference>__ReferenceID24</x:Reference><x:Reference>__ReferenceID25</x:Reference></ActionActivity.StageActivityVariables></ActionActivity></ServerActivity><p:Sequence DisplayName=""Sequence"" sap:VirtualizedContainerService.HintSize=""222.4,100.8"" /></DeploymentSequenceActivity>";

            // Act
            var sequence = (new RMDeploymentSequence { StageId = 100, WorkflowXaml = testXml }).ToReleaseTemplate();

            // Assert
            Assert.IsNotNull(sequence.Containers);
            Assert.AreEqual(2, sequence.Containers.Count());
        }

        [TestMethod]
        public void Can_Parse_A_Deployment_Sequence_With_Single_Parallel_Block()
        {
            // Arrange
            var testXml =
                @"<DeploymentSequenceActivity xmlns=""clr-namespace:Microsoft.TeamFoundation.Release.Workflow.Activities;assembly=Microsoft.TeamFoundation.Release.Workflow"" xmlns:mtrdm=""clr-namespace:Microsoft.TeamFoundation.Release.Data.Model;assembly=Microsoft.TeamFoundation.Release.Data"" xmlns:mva=""clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"" xmlns:p=""http://schemas.microsoft.com/netfx/2009/xaml/activities"" xmlns:sap=""http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"" xmlns:scg=""clr-namespace:System.Collections.Generic;assembly=mscorlib"" xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml"" DisplayName=""Deployment Sequence"" sap:VirtualizedContainerService.HintSize=""222.4,227.2"" mva:VisualBasic.Settings=""Assembly references and imported namespaces serialized as XML namespaces""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><p:Parallel DisplayName=""Parallel placeholder"" sap:VirtualizedContainerService.HintSize=""200,102.4"" /></DeploymentSequenceActivity>";

            // Act
            var sequence = (new RMDeploymentSequence { StageId = 100, WorkflowXaml = testXml }).ToReleaseTemplate();

            // Assert
            var containers = sequence.Containers.ToList();

            Assert.AreEqual(1, containers.Count);
            Assert.AreEqual("Parallel placeholder", containers[0].DisplayName);
        }

        [TestMethod]
        public void Can_Parse_A_Deployment_Sequence_With_Single_Server_Tag()
        {
            // Arrange
            var testXml =
                @"<DeploymentSequenceActivity xmlns=""clr-namespace:Microsoft.TeamFoundation.Release.Workflow.Activities;assembly=Microsoft.TeamFoundation.Release.Workflow"" xmlns:mtrdm=""clr-namespace:Microsoft.TeamFoundation.Release.Data.Model;assembly=Microsoft.TeamFoundation.Release.Data"" xmlns:mva=""clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"" xmlns:p=""http://schemas.microsoft.com/netfx/2009/xaml/activities"" xmlns:sap=""http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"" xmlns:scg=""clr-namespace:System.Collections.Generic;assembly=mscorlib"" xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml"" DisplayName=""Deployment Sequence"" sap:VirtualizedContainerService.HintSize=""244.8,302.4"" mva:VisualBasic.Settings=""Assembly references and imported namespaces serialized as XML namespaces""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><ServerTagActivity ExecutionMode=""1"" sap:VirtualizedContainerService.HintSize=""222.4,177.6"" InstanceSequenceNumber=""1"" TagName=""placeholder""><ActionActivity DisplayName=""Start Service"" sap:VirtualizedContainerService.HintSize=""200,52.8"" IsSkipped=""False"" WorkflowActivityId=""cfa898b7-299b-4b2b-936b-0049165e5e8c""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Start Service"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3989"" HasPendingSecurityChanges=""False"" Id=""1478"" IsDeletable=""True"" IsDirty=""False"" IsSerializing=""False"" IsTagBased=""1"" LinkedV2ComponentId=""0"" ServerId=""0"" ServerInstanceSequenceNumber=""1"" StatusId=""2"" StatusName=""Active"" TagName=""placeholder"" WorkflowActivityId=""cfa898b7-299b-4b2b-936b-0049165e5e8c""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""1"" ApplyFullValidation=""False"" Arguments=""-command ./ManageWindowsServices.ps1 -Action Start -ServiceName '__ServiceName__'"" CategoryId=""1999"" CategoryName=""Windows Services"" Command=""powershell"" DeployerToolId=""2012"" DeploymentMethod=""2013"" Description=""Start a Windows Service"" HasPendingSecurityChanges=""False"" Id=""3989"" InMemoryStatus=""Existing"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""False"" IsSerializing=""False"" Name=""Start Service"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""3"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID0"" Id=""9969"" Name=""ServiceName"" Value="""" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID1"" Id=""9969"" Name=""ServiceName"" Value="""" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID1</x:Reference></ActionActivity.StageActivityVariables></ActionActivity></ServerTagActivity></DeploymentSequenceActivity>";

            // Act
            var sequence = (new RMDeploymentSequence { StageId = 100, WorkflowXaml = testXml }).ToReleaseTemplate();

            // Assert
            Assert.AreEqual(1, sequence.Containers.Count());
            Assert.AreEqual("placeholder", sequence.Containers.First().DisplayName);
        }

        [TestMethod]
        public void Can_Parse_A_Deployment_Sequence_With_Single_Server_Tag_And_Sequence_And_Server()
        {
            // Arrange
            var testXml =
                @"<DeploymentSequenceActivity xmlns=""clr-namespace:Microsoft.TeamFoundation.Release.Workflow.Activities;assembly=Microsoft.TeamFoundation.Release.Workflow"" xmlns:mtrdm=""clr-namespace:Microsoft.TeamFoundation.Release.Data.Model;assembly=Microsoft.TeamFoundation.Release.Data"" xmlns:mva=""clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"" xmlns:p=""http://schemas.microsoft.com/netfx/2009/xaml/activities"" xmlns:sap=""http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"" xmlns:scg=""clr-namespace:System.Collections.Generic;assembly=mscorlib"" xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml"" DisplayName=""Deployment Sequence"" sap:VirtualizedContainerService.HintSize=""244.8,660.8"" mva:VisualBasic.Settings=""Assembly references and imported namespaces serialized as XML namespaces""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><ServerActivity sap:VirtualizedContainerService.HintSize=""222.4,177.6"" InstanceSequenceNumber=""1"" ServerId=""19"" ServerName=""lab-dmann""><ActionActivity DisplayName=""Stop Service"" sap:VirtualizedContainerService.HintSize=""200,52.8"" IsSkipped=""False"" WorkflowActivityId=""34dfdf57-888c-41c6-8f4d-90b1ffa4039d""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Stop Service"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3991"" HasPendingSecurityChanges=""False"" Id=""-212626"" IsDeletable=""True"" IsDirty=""True"" IsSerializing=""False"" IsTagBased=""0"" LinkedV2ComponentId=""0"" ServerId=""19"" ServerInstanceSequenceNumber=""1"" ServerName=""lab-dmann"" StatusId=""2"" StatusName=""Active"" WorkflowActivityId=""34dfdf57-888c-41c6-8f4d-90b1ffa4039d""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""2"" ActionTypeName=""Custom action"" ApplyFullValidation=""False"" CategoryId=""1999"" CategoryName=""Windows Services"" DeployerToolId=""0"" DeploymentMethod=""2013"" Description=""Stop a Windows Service"" HasPendingSecurityChanges=""False"" Id=""3991"" InMemoryStatus=""New"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""True"" IsSerializing=""False"" Name=""Stop Service"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""4"" TypeName=""Without source"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID0"" Id=""9971"" Name=""ServiceName"" Value="""" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID0</x:Reference></ActionActivity.StageActivityVariables></ActionActivity></ServerActivity><ServerTagActivity ExecutionMode=""1"" sap:VirtualizedContainerService.HintSize=""222.4,177.6"" InstanceSequenceNumber=""1"" TagName=""placeholder""><ActionActivity DisplayName=""Start Service"" sap:VirtualizedContainerService.HintSize=""200,52.8"" IsSkipped=""False"" WorkflowActivityId=""cfa898b7-299b-4b2b-936b-0049165e5e8c""><ActionActivity.StageActivity><mtrdm:StageActivity ActivityDisplayName=""Start Service"" ApplyFullValidation=""False"" CanEditVariables=""True"" ComponentId=""3989"" HasPendingSecurityChanges=""False"" Id=""1480"" IsDeletable=""True"" IsDirty=""False"" IsSerializing=""False"" IsTagBased=""1"" LinkedV2ComponentId=""0"" ServerId=""0"" ServerInstanceSequenceNumber=""1"" StatusId=""2"" StatusName=""Active"" TagName=""placeholder"" WorkflowActivityId=""cfa898b7-299b-4b2b-936b-0049165e5e8c""><mtrdm:StageActivity.Component><mtrdm:Component ActionTypeId=""1"" ApplyFullValidation=""False"" Arguments=""-command ./ManageWindowsServices.ps1 -Action Start -ServiceName '__ServiceName__'"" CategoryId=""1999"" CategoryName=""Windows Services"" Command=""powershell"" DeployerToolId=""2012"" DeploymentMethod=""2013"" Description=""Start a Windows Service"" HasPendingSecurityChanges=""False"" Id=""3989"" InMemoryStatus=""Existing"" IsDeletable=""True"" IsDirty=""False"" IsPublishedByMicrosoft=""False"" IsSerializing=""False"" Name=""Start Service"" StatusId=""2"" StatusName=""Active"" TeamFoundationServerId=""0"" TeamProjectCollectionId=""0"" Timeout=""5"" TypeId=""3"" VariableReplacementModeId=""1"" Version=""2013""><mtrdm:Component.ConfigurationVariables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID1"" Id=""9969"" Name=""ServiceName"" Value="""" /></mtrdm:Component.ConfigurationVariables><mtrdm:Component.PropertyBagVariables><mtrdm:SortableObservableCollection x:TypeArguments=""mtrdm:ConfigurationVariable"" /></mtrdm:Component.PropertyBagVariables></mtrdm:Component></mtrdm:StageActivity.Component><mtrdm:StageActivity.Variables><mtrdm:ConfigurationVariable x:Name=""__ReferenceID2"" Id=""9969"" Name=""ServiceName"" Value="""" /></mtrdm:StageActivity.Variables></mtrdm:StageActivity></ActionActivity.StageActivity><ActionActivity.StageActivityVariables><x:Reference>__ReferenceID2</x:Reference></ActionActivity.StageActivityVariables></ActionActivity></ServerTagActivity><p:Sequence DisplayName=""Sequence"" sap:VirtualizedContainerService.HintSize=""222.4,100.8"" /></DeploymentSequenceActivity>";

            // Act
            var sequence = (new RMDeploymentSequence { StageId = 100, WorkflowXaml = testXml }).ToReleaseTemplate();

            // Assert
            var containers = sequence.Containers.ToList();
            Assert.AreEqual(3, containers.Count());
            Assert.IsTrue(containers.Any(x => x.ItemType == BlockType.Server));
            Assert.IsTrue(containers.Any(x => x.ItemType == BlockType.ServerTag));
            Assert.IsTrue(containers.Any(x => x.ItemType == BlockType.Sequence));
        }

        [TestMethod]
        public void Can_Parse_An_Empty_Deployment_Sequence()
        {
            // Arrange
            var testXml =
                @"<DeploymentSequenceActivity xmlns=""clr-namespace:Microsoft.TeamFoundation.Release.Workflow.Activities;assembly=Microsoft.TeamFoundation.Release.Workflow"" xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml"" DisplayName=""Deployment Sequence"" />";

            // Act
            var sequence = (new RMDeploymentSequence { StageId = 100, WorkflowXaml = testXml }).ToReleaseTemplate();

            // Assert
            Assert.IsNotNull(sequence);
            Assert.AreEqual("Deployment Sequence", sequence.DisplayName);
        }

        [TestMethod]
        public void Event_Fires_When_A_Container_Is_Parsed()
        {
            // Arrange
            var testXml =
                @"<DeploymentSequenceActivity xmlns=""clr-namespace:Microsoft.TeamFoundation.Release.Workflow.Activities;assembly=Microsoft.TeamFoundation.Release.Workflow"" xmlns:mtrdm=""clr-namespace:Microsoft.TeamFoundation.Release.Data.Model;assembly=Microsoft.TeamFoundation.Release.Data"" xmlns:mva=""clr-namespace:Microsoft.VisualBasic.Activities;assembly=System.Activities"" xmlns:p=""http://schemas.microsoft.com/netfx/2009/xaml/activities"" xmlns:sap=""http://schemas.microsoft.com/netfx/2009/xaml/activities/presentation"" xmlns:scg=""clr-namespace:System.Collections.Generic;assembly=mscorlib"" xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml"" DisplayName=""Deployment Sequence"" sap:VirtualizedContainerService.HintSize=""222.4,227.2"" mva:VisualBasic.Settings=""Assembly references and imported namespaces serialized as XML namespaces""><sap:WorkflowViewStateService.ViewState><scg:Dictionary x:TypeArguments=""x:String, x:Object""><x:Boolean x:Key=""IsExpanded"">True</x:Boolean></scg:Dictionary></sap:WorkflowViewStateService.ViewState><p:Parallel DisplayName=""Parallel placeholder"" sap:VirtualizedContainerService.HintSize=""200,102.4"" /></DeploymentSequenceActivity>";

            var eventFired = false;

            ContainerParser.ContainerParsed += (sender, args) =>
                {
                    Assert.AreEqual("Parallel placeholder", args.DisplayName);
                    Assert.AreEqual(BlockType.Parallel, args.ItemType);
                    eventFired = true;
                };

            // Act
            (new RMDeploymentSequence { StageId = 100, WorkflowXaml = testXml }).ToReleaseTemplate();
            Assert.IsTrue(eventFired);
        }

        [TestCleanup]
        public void TestCleanup()
        {
            ContainerParser.ContainerParsed = null;
        }
    }
}

// ReSharper restore InconsistentNaming